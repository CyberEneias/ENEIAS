-- ===== AUTOFARM + SPEED + INFINITE JUMP + KILLAURA (FIST COMBAT) =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
if not player then return end

-- ===== REMOTE =====
local CombatEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("CombatEvent")

-- ===== CONFIG (SEUS VALORES) =====
local COMBAT = {
	Damage = 8,
	Range = 5,
	Size = Vector3.new(6.5, 5, 6),
	Stun = 0.65,
	PunchedTime = 0.1
}

local CONFIG = {
	MAX_DISTANCE = 8,
	NPC_SCAN_INTERVAL = 0.3,
	GUI_NAME = "InfoExperienciaGui"
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	killauraEnabled = false,
	lastAttack = 0,
	lastScan = 0,
	npcCache = {},
	connections = {},

	-- combat detection
	formatIndex = nil,
	combo = 1
}

-- ===== UTILS =====
local function disconnect(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== GUI CLEAN =====
local old = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if old then old:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 300, 0, 180)
frame.Position = UDim2.new(0.5, -150, 0.5, -90)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,40)
title.BackgroundTransparency = 1
title.Text = "⚔️ KILLAURA TEST"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = Color3.fromRGB(235,235,235)

local btn = Instance.new("TextButton", frame)
btn.Size = UDim2.new(0, 240, 0, 45)
btn.Position = UDim2.new(0.5, -120, 0, 70)
btn.BackgroundColor3 = Color3.fromRGB(70,90,110)
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.GothamBold
btn.TextSize = 15
btn.Text = "⚔️ Killaura: OFF"
Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

-- ===== NPC CACHE =====
local function updateNPCs()
	table.clear(state.npcCache)

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChildOfClass("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				if (root.Position - npcRoot.Position).Magnitude <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, npc)
				end
			end
		end
	end
end

local function getClosestNPC()
	if tick() - state.lastScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCs()
		state.lastScan = tick()
	end
	return state.npcCache[1]
end

-- ===== COMBAT PAYLOAD =====
local function getAction()
	local action = "P_" .. state.combo
	state.combo += 1
	if state.combo > 4 then
		state.combo = 1
	end
	return action
end

local function buildData(root)
	return {
		Damage = COMBAT.Damage,
		Stun = COMBAT.Stun,
		Range = COMBAT.Range,
		Size = COMBAT.Size,
		CFrame = root.CFrame
	}
end

-- ===== FORMAT TESTS =====
local function tryFormats(npc)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local action = getAction()
	local data = buildData(root)

	local tests = {
		function() CombatEvent:FireServer(action, data) end,
		function() CombatEvent:FireServer(action, npc) end,
		function() CombatEvent:FireServer(action, npc, data) end,
		function() CombatEvent:FireServer(npc, action, data) end,
	}

	for i, fn in ipairs(tests) do
		local ok = pcall(fn)
		if ok then
			state.formatIndex = i
			return
		end
	end
end

local function fireCombat(npc)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local action = getAction()
	local data = buildData(root)

	if state.formatIndex == 1 then
		CombatEvent:FireServer(action, data)
	elseif state.formatIndex == 2 then
		CombatEvent:FireServer(action, npc)
	elseif state.formatIndex == 3 then
		CombatEvent:FireServer(action, npc, data)
	elseif state.formatIndex == 4 then
		CombatEvent:FireServer(npc, action, data)
	end
end

-- ===== KILLAURA LOOP =====
local function killauraLoop()
	if not state.killauraEnabled then return end
	if tick() - state.lastAttack < COMBAT.PunchedTime then return end

	local npc = getClosestNPC()
	if not npc then return end

	if not state.formatIndex then
		tryFormats(npc)
	else
		fireCombat(npc)
	end

	state.lastAttack = tick()
end

-- ===== BUTTON =====
btn.MouseButton1Click:Connect(function()
	state.killauraEnabled = not state.killauraEnabled
	btn.Text = state.killauraEnabled and "⚔️ Killaura: ON" or "⚔️ Killaura: OFF"

	disconnect("killaura")
	if state.killauraEnabled then
		state.connections.killaura = RunService.Heartbeat:Connect(killauraLoop)
	end
end)

