-- ===== AUTOFARM ULTRA-LEVE + GOD MODE + SPEED + INFINITE JUMP + KILL AURA =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
if not player then return end

-- ===== REMOTE =====
local combatEvent = ReplicatedStorage:WaitForChild("events"):WaitForChild("combatEvent")

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	KILL_AURA_RANGE = 18,
	KILL_AURA_INTERVAL = 0.25,
	NPC_SCAN_INTERVAL = 0.3,
	GUI_NAME = "InfoExperienciaGui"
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== CACHE =====
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	killAuraEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	godModeEnabled = false,

	speedValue = 160,
	lastAura = 0,
	lastNPCScan = 0,

	npcCache = {},
	lockedNPC = nil,
	connections = {},

	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
}

-- ===== UTILS =====
local function disconnect(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== CLEAN GUI =====
local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if oldGui then oldGui:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2_new(0, 580, 0, 390)
frame.Position = UDim2_new(0.5, -290, 0.5, -195)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2_new(1,0,0,50)
title.BackgroundTransparency = 1
title.Text = "ðŸ”¥ AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(235,235,235)

local function createButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2_new(0, 240, 0, 45)
	b.Position = UDim2_new(0, 20, 0, y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local autofarmBtn = createButton("ðŸ¤– Autofarm: OFF", 60)
local auraBtn     = createButton("âš”ï¸ Kill Aura: OFF", 120)
local godBtn      = createButton("ðŸ›¡ï¸ God Mode: OFF", 180)
local jumpBtn     = createButton("ðŸš€ Infinite Jump: OFF", 240)
local speedBtn    = createButton("ðŸ’¨ Speed: OFF", 300)

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChildOfClass("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {
						model = npc,
						root = npcRoot,
						humanoid = hum,
						distance = dist
					})
				end
			end
		end
	end

	table.sort(state.npcCache, function(a,b)
		return a.distance < b.distance
	end)
end

-- ===== KILL AURA LOOP =====
local function killAuraLoop()
	if not state.killAuraEnabled then return end
	if tick() - state.lastAura < CONFIG.KILL_AURA_INTERVAL then return end
	state.lastAura = tick()

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	if tick() - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = tick()
	end

	for _, npcData in ipairs(state.npcCache) do
		if npcData.distance <= CONFIG.KILL_AURA_RANGE then
			-- ðŸ”¥ AJUSTE AQUI SE O SEU combatEvent PEDIR MAIS ARGUMENTOS
			combatEvent:FireServer(npcData.model)
		end
	end
end

-- ===== AUTOFARM LOOP =====
local function autofarmLoop()
	if not state.autofarmEnabled then return end

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	if not state.lockedNPC or not state.lockedNPC.Parent then
		updateNPCCache()
		state.lockedNPC = state.npcCache[1] and state.npcCache[1].model
	end

	local npc = state.lockedNPC
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero

	root.CFrame = CFrame_new(
		npcRoot.Position
		- npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
		+ Vector3_new(0, CONFIG.HEIGHT_OFFSET, 0)
	)
end

-- ===== BUTTONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ðŸ¤– Autofarm: ON" or "ðŸ¤– Autofarm: OFF"
	disconnect("autofarm")
	if state.autofarmEnabled then
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	end
end)

auraBtn.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	auraBtn.Text = state.killAuraEnabled and "âš”ï¸ Kill Aura: ON" or "âš”ï¸ Kill Aura: OFF"
	disconnect("aura")
	if state.killAuraEnabled then
		state.connections.aura = RunService.Heartbeat:Connect(killAuraLoop)
	end
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "ðŸš€ Infinite Jump: ON" or "ðŸš€ Infinite Jump: OFF"
end)

UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)
