-- ===== AUTOFARM ULTRA-LEVE COM ANTI-KNOCKBACK, INFINITE JUMP E VELOCITY SPEED =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONSTANTES =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	UPDATE_INTERVAL = 1,
	GUI_NAME = "InfoExperienciaGui",
	NPC_SCAN_INTERVAL = 0.3
}

local COLORS = {
	BACKGROUND = Color3.fromRGB(25, 25, 30),
	HEADER = Color3.fromRGB(35, 35, 45),
	CLOSE_BTN = Color3.fromRGB(231, 76, 60),
	MINIMIZE_BTN = Color3.fromRGB(241, 196, 15),
	BTN_OFF = Color3.fromRGB(52, 73, 94),
	BTN_ON = Color3.fromRGB(46, 204, 113),
	TEXT = Color3.fromRGB(236, 240, 241),
	TEXT_SECONDARY = Color3.fromRGB(149, 165, 166),
	INPUT_BG = Color3.fromRGB(44, 62, 80),
	ACCENT = Color3.fromRGB(52, 152, 219)
}

-- ===== CACHE =====
local workspace = workspace
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	speedValue = 50,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	connections = {},
	guiVisible = true
}

-- ===== UTILITY FUNCTIONS =====
local function cleanupOldGui()
	local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
	if oldGui then
		oldGui:Destroy()
	end
end

local function createUICorner(radius, parent)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius)
	corner.Parent = parent
	return corner
end

local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

local function createButton(parent, size, position, text, color)
	local btn = Instance.new("TextButton")
	btn.Parent = parent
	btn.Size = size
	btn.Position = position
	btn.BackgroundColor3 = color
	btn.TextColor3 = COLORS.TEXT
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 16
	btn.Text = text
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	createUICorner(8, btn)
	
	-- Hover effect
	btn.MouseEnter:Connect(function()
		btn.BackgroundColor3 = Color3.fromRGB(
			math.min(255, color.R * 255 + 20),
			math.min(255, color.G * 255 + 20),
			math.min(255, color.B * 255 + 20)
		)
	end)
	
	btn.MouseLeave:Connect(function()
		btn.BackgroundColor3 = color
	end)
	
	return btn
end

-- ===== GUI CREATION =====
cleanupOldGui()

local screenGui = Instance.new("ScreenGui")
screenGui.Name = CONFIG.GUI_NAME
screenGui.ResetOnSpawn = false
screenGui.Parent = CoreGui

local frame = Instance.new("Frame")
frame.Parent = screenGui
frame.Size = UDim2_new(0, 680, 0, 280)
frame.Position = UDim2_new(0.5, -340, 0.5, -140)
frame.BackgroundColor3 = COLORS.BACKGROUND
frame.BorderSizePixel = 0
frame.Active = true
createUICorner(16, frame)

-- Sombra
local shadow = Instance.new("ImageLabel")
shadow.Parent = frame
shadow.BackgroundTransparency = 1
shadow.Position = UDim2_new(0, -15, 0, -15)
shadow.Size = UDim2_new(1, 30, 1, 30)
shadow.ZIndex = 0
shadow.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.5

-- Header
local header = Instance.new("Frame")
header.Parent = frame
header.Size = UDim2_new(1, 0, 0, 50)
header.Position = UDim2_new(0, 0, 0, 0)
header.BackgroundColor3 = COLORS.HEADER
header.BorderSizePixel = 0
createUICorner(16, header)

local headerBottom = Instance.new("Frame")
headerBottom.Parent = header
headerBottom.Size = UDim2_new(1, 0, 0, 16)
headerBottom.Position = UDim2_new(0, 0, 1, -16)
headerBottom.BackgroundColor3 = COLORS.HEADER
headerBottom.BorderSizePixel = 0

-- T√≠tulo
local titleLabel = Instance.new("TextLabel")
titleLabel.Parent = header
titleLabel.Size = UDim2_new(1, -120, 1, 0)
titleLabel.Position = UDim2_new(0, 20, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = COLORS.TEXT
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 20
titleLabel.Text = "üéÆ AUTOFARM CONTROLLER"
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Bot√£o minimizar
local minimizeButton = Instance.new("TextButton")
minimizeButton.Parent = header
minimizeButton.Size = UDim2_new(0, 35, 0, 35)
minimizeButton.Position = UDim2_new(1, -80, 0, 7.5)
minimizeButton.BackgroundColor3 = COLORS.MINIMIZE_BTN
minimizeButton.TextColor3 = COLORS.TEXT
minimizeButton.Font = Enum.Font.GothamBold
minimizeButton.Text = "‚Äî"
minimizeButton.TextSize = 20
minimizeButton.BorderSizePixel = 0
createUICorner(8, minimizeButton)

-- Bot√£o de fechar
local closeButton = Instance.new("TextButton")
closeButton.Parent = header
closeButton.Size = UDim2_new(0, 35, 0, 35)
closeButton.Position = UDim2_new(1, -40, 0, 7.5)
closeButton.BackgroundColor3 = COLORS.CLOSE_BTN
closeButton.TextColor3 = COLORS.TEXT
closeButton.Font = Enum.Font.GothamBold
closeButton.Text = "√ó"
closeButton.TextSize = 24
closeButton.BorderSizePixel = 0
createUICorner(8, closeButton)

-- Container principal
local container = Instance.new("Frame")
container.Parent = frame
container.Size = UDim2_new(1, -40, 1, -70)
container.Position = UDim2_new(0, 20, 0, 60)
container.BackgroundTransparency = 1

-- Info Section
local infoFrame = Instance.new("Frame")
infoFrame.Parent = container
infoFrame.Size = UDim2_new(1, 0, 0, 70)
infoFrame.Position = UDim2_new(0, 0, 0, 0)
infoFrame.BackgroundColor3 = COLORS.HEADER
infoFrame.BorderSizePixel = 0
createUICorner(12, infoFrame)

local textLabel = Instance.new("TextLabel")
textLabel.Parent = infoFrame
textLabel.Size = UDim2_new(0.6, -20, 1, -20)
textLabel.Position = UDim2_new(0, 15, 0, 10)
textLabel.BackgroundTransparency = 1
textLabel.TextColor3 = COLORS.TEXT
textLabel.Font = Enum.Font.Gotham
textLabel.TextSize = 14
textLabel.TextWrapped = true
textLabel.TextXAlignment = Enum.TextXAlignment.Left
textLabel.TextYAlignment = Enum.TextYAlignment.Top

local statusLabel = Instance.new("TextLabel")
statusLabel.Parent = infoFrame
statusLabel.Size = UDim2_new(0.4, -20, 1, -20)
statusLabel.Position = UDim2_new(0.6, 5, 0, 10)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = COLORS.ACCENT
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextSize = 16
statusLabel.TextXAlignment = Enum.TextXAlignment.Right
statusLabel.TextYAlignment = Enum.TextYAlignment.Center
statusLabel.Text = "üéØ NPC: Nenhum"

-- Bot√µes principais
local buttonY = 85
local autofarmBtn = createButton(container, UDim2_new(0, 200, 0, 45), UDim2_new(0, 0, 0, buttonY), "ü§ñ Autofarm: OFF", COLORS.BTN_OFF)
local jumpBtn = createButton(container, UDim2_new(0, 200, 0, 45), UDim2_new(0, 220, 0, buttonY), "üöÄ Infinite Jump: OFF", COLORS.BTN_OFF)

-- Speed Section
local speedFrame = Instance.new("Frame")
speedFrame.Parent = container
speedFrame.Size = UDim2_new(1, 0, 0, 60)
speedFrame.Position = UDim2_new(0, 0, 0, 145)
speedFrame.BackgroundColor3 = COLORS.HEADER
speedFrame.BorderSizePixel = 0
createUICorner(12, speedFrame)

local speedLabel = Instance.new("TextLabel")
speedLabel.Parent = speedFrame
speedLabel.Size = UDim2_new(0, 150, 0, 20)
speedLabel.Position = UDim2_new(0, 15, 0, 10)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "‚ö° Velocity Speed"
speedLabel.TextColor3 = COLORS.TEXT
speedLabel.Font = Enum.Font.GothamBold
speedLabel.TextSize = 16
speedLabel.TextXAlignment = Enum.TextXAlignment.Left

local speedBox = Instance.new("TextBox")
speedBox.Parent = speedFrame
speedBox.Size = UDim2_new(0, 100, 0, 35)
speedBox.Position = UDim2_new(0, 15, 0, 35)
speedBox.BackgroundColor3 = COLORS.INPUT_BG
speedBox.TextColor3 = COLORS.TEXT
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 18
speedBox.PlaceholderText = "50"
speedBox.Text = tostring(state.speedValue)
speedBox.ClearTextOnFocus = false
speedBox.BorderSizePixel = 0
createUICorner(8, speedBox)

local speedToggle = createButton(speedFrame, UDim2_new(0, 200, 0, 45), UDim2_new(0, 130, 0, 7.5), "üí® Speed: OFF", COLORS.BTN_OFF)

-- Indicador de vers√£o
local versionLabel = Instance.new("TextLabel")
versionLabel.Parent = container
versionLabel.Size = UDim2_new(1, 0, 0, 15)
versionLabel.Position = UDim2_new(0, 0, 1, -15)
versionLabel.BackgroundTransparency = 1
versionLabel.TextColor3 = COLORS.TEXT_SECONDARY
versionLabel.Font = Enum.Font.Gotham
versionLabel.TextSize = 11
versionLabel.Text = "v2.0 Ultra-Leve | Pressione F1 para minimizar"
versionLabel.TextXAlignment = Enum.TextXAlignment.Center

-- ===== DRAG FUNCTIONALITY =====
do
	local dragging, dragStart, startPos = false, nil, nil

	local function updateDrag(input)
		local delta = input.Position - dragStart
		frame.Position = UDim2_new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end

	header.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or 
		   input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or 
		                 input.UserInputType == Enum.UserInputType.Touch) then
			updateDrag(input)
		end
	end)
end

-- ===== F1 TOGGLE =====
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	
	if input.KeyCode == Enum.KeyCode.F1 then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)

minimizeButton.MouseButton1Click:Connect(function()
	state.guiVisible = false
	frame.Visible = false
end)

-- ===== AUTOFARM ULTRA-LEVE (OTIMIZADO) =====

local autofarmThread
local npcScanThread

-- Busca o NPC mais pr√≥ximo (SEM GetDescendants frequente)
local function findNearestNPC()
	local character = player.Character
	if not character then return nil end

	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return nil end

	local closestNPC
	local closestDistance = CONFIG.MAX_DISTANCE

	for _, model in ipairs(workspace:GetChildren()) do
		if model:IsA("Model") and model ~= character then
			local hum = model:FindFirstChild("Humanoid")
			local npcRoot = model:FindFirstChild("HumanoidRootPart")

			if hum and npcRoot and hum.Health > 0 and
			   not Players:GetPlayerFromCharacter(model) then

				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist < closestDistance then
					closestDistance = dist
					closestNPC = model
				end
			end
		end
	end

	return closestNPC
end

-- Thread de scan (roda DEVAGAR)
local function startNPCScanner()
	if npcScanThread then return end

	npcScanThread = task.spawn(function()
		while state.autofarmEnabled do
			if not isNPCValid(state.lockedNPC) then
				state.lockedNPC = findNearestNPC()
			end
			task.wait(2) -- üî• MUITO IMPORTANTE
		end
		npcScanThread = nil
	end)
end

-- Loop principal do autofarm (leve)
local function startAutofarmLoop()
	if autofarmThread then return end

	autofarmThread = task.spawn(function()
		while state.autofarmEnabled do
			local character = player.Character
			local npc = state.lockedNPC

			if character and npc then
				local root = character:FindFirstChild("HumanoidRootPart")
				local npcRoot = npc:FindFirstChild("HumanoidRootPart")

				if root and npcRoot then
					local npcCF = npcRoot.CFrame
					local targetPos =
						npcRoot.Position
						- npcCF.LookVector * CONFIG.BACK_DISTANCE
						+ Vector3.new(0, CONFIG.HEIGHT_OFFSET, 0)

					-- Anti-knockback LEVE
					if root.AssemblyLinearVelocity.Magnitude > 25 then
						root.AssemblyLinearVelocity = Vector3.zero
					end

					root.CFrame = CFrame.new(targetPos)
					statusLabel.Text = "üéØ NPC: " .. npc.Name
				end
			else
				statusLabel.Text = "üéØ NPC: Procurando..."
			end

			task.wait(0.1) -- üî• 10x por segundo (suave)
		end

		autofarmThread = nil
	end)
end

-- Bot√£o Autofarm
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled

	if state.autofarmEnabled then
		state.lockedNPC = nil
		startNPCScanner()
		startAutofarmLoop()

		autofarmBtn.Text = "ü§ñ Autofarm: ON"
		autofarmBtn.BackgroundColor3 = COLORS.BTN_ON
	else
		state.lockedNPC = nil

		autofarmBtn.Text = "ü§ñ Autofarm: OFF"
		autofarmBtn.BackgroundColor3 = COLORS.BTN_OFF
		statusLabel.Text = "üéØ NPC: Nenhum"
	end
end)


-- ===== INFINITE JUMP =====
jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	
	if state.infiniteJumpEnabled then
		jumpBtn.Text = "üöÄ Infinite Jump: ON"
		jumpBtn.BackgroundColor3 = COLORS.BTN_ON
	else
		jumpBtn.Text = "üöÄ Infinite Jump: OFF"
		jumpBtn.BackgroundColor3 = COLORS.BTN_OFF
	end
end)

UserInputService.JumpRequest:Connect(function()
	if not state.infiniteJumpEnabled then return end
	
	local character = player.Character
	if not character then return end
	
	local humanoid = character:FindFirstChild("Humanoid")
	if humanoid then
		humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
	end
end)

-- ===== VELOCITY SPEED =====
local function velocitySpeedLoop()
	if not state.speedEnabled then return end

	local char = player.Character
	if not char then return end

	local root = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChildOfClass("Humanoid")

	if root and hum then
		local moveDir = hum.MoveDirection
		if moveDir.Magnitude > 0 then
			local currentY = root.AssemblyLinearVelocity.Y
			root.AssemblyLinearVelocity = (moveDir.Unit * state.speedValue) + 
			                               Vector3_new(0, currentY, 0)
		end
	end
end

local function startVelocitySpeed()
	disconnectConnection("speed")
	state.connections.speed = RunService.Heartbeat:Connect(velocitySpeedLoop)
end

speedToggle.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled

	if state.speedEnabled then
		local value = tonumber(speedBox.Text)
		if value and value > 0 then
			state.speedValue = value
		end

		speedToggle.Text = "üí® Speed: ON"
		speedToggle.BackgroundColor3 = COLORS.BTN_ON
		startVelocitySpeed()
	else
		speedToggle.Text = "üí® Speed: OFF"
		speedToggle.BackgroundColor3 = COLORS.BTN_OFF
		disconnectConnection("speed")
	end
end)

speedBox.FocusLost:Connect(function()
	local value = tonumber(speedBox.Text)
	if value and value > 0 then
		state.speedValue = value
	end
end)

-- ===== UPDATES =====
task.spawn(function()
	local nomeExperiencia = game.Name
	while frame.Parent do
		textLabel.Text = string.format(
			"üìç Experi√™ncia: %s\n‚è∞ %s",
			nomeExperiencia,
			os.date("%d/%m/%Y - %H:%M:%S")
		)
		task.wait(CONFIG.UPDATE_INTERVAL)
	end
end)

-- ===== CLEANUP =====
closeButton.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

screenGui.Destroying:Connect(function()
	for name, _ in pairs(state.connections) do
		disconnectConnection(name)
	end
	table.clear(state.npcCache)
end)

player.CharacterAdded:Connect(function()
	task.wait(0.3)
	if state.speedEnabled then
		startVelocitySpeed()
	end
end)
