-- ===== AUTOFARM + GOD + SPEED + INFINITE JUMP + M1 MACRO (FIXED) =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	GUI_NAME = "InfoExperienciaGui",
	NPC_SCAN_INTERVAL = 0.3
}

local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	speedEnabled = false,
	infiniteJumpEnabled = false,
	godModeEnabled = false,
	m1MacroEnabled = false,

	speedValue = 160,
	m1Delay = 0.08,
	m1Hotkey = Enum.KeyCode.F2,

	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},

	connections = {},
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1
}

-- ===== UTILS =====
local function disconnect(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== GUI CLEAN =====
local old = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if old then old:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,560,0,400)
frame.Position = UDim2.new(0.5,-280,0.5,-200)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,50)
title.BackgroundTransparency = 1
title.Text = "ğŸ”¥ AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(235,235,235)

-- ===== BUTTON FACTORY =====
local function createButton(text,y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0,220,0,45)
	b.Position = UDim2.new(0,20,0,y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

-- ===== BUTTONS =====
local autofarmBtn = createButton("ğŸ¤– Autofarm: OFF",60)
local speedBtn    = createButton("ğŸ’¨ Speed: OFF",120)
local jumpBtn     = createButton("ğŸš€ Infinite Jump: OFF",180)
local m1Btn       = createButton("ğŸ–±ï¸ M1 Macro: OFF (F2)",240)

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	for _,npc in ipairs(AliveFolder:GetChildren()) do
		local hum = npc:FindFirstChild("Humanoid")
		local r = npc:FindFirstChild("HumanoidRootPart")
		if hum and r and hum.Health > 0 then
			local dist = (root.Position - r.Position).Magnitude
			if dist <= CONFIG.MAX_DISTANCE then
				table.insert(state.npcCache,{model=npc,root=r,dist=dist})
			end
		end
	end
	table.sort(state.npcCache,function(a,b) return a.dist < b.dist end)
end

local function getClosestNPC()
	if tick() - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = tick()
	end
	return state.npcCache[1] and state.npcCache[1].model
end

-- ===== AUTOFARM LOOP =====
local function autofarmLoop()
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	if not state.lockedNPC or not state.lockedNPC.Parent then
		state.lockedNPC = getClosestNPC()
	end
	if not state.lockedNPC then return end

	local npcRoot = state.lockedNPC:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	root.AssemblyLinearVelocity = Vector3.zero
	root.CFrame =
		npcRoot.CFrame
		- npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
		+ Vector3.new(0,CONFIG.HEIGHT_OFFSET,0)
end

-- ===== SPEED LOOP =====
local function speedLoop()
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if root and hum and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity = hum.MoveDirection.Unit * state.speedValue
	end
end

-- ===== M1 LOOP =====
local function m1Loop()
	VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
	task.wait(0.01)
	VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
end

-- ===== TOGGLES =====
local function toggleM1()
	state.m1MacroEnabled = not state.m1MacroEnabled
	m1Btn.Text = state.m1MacroEnabled and "ğŸ–±ï¸ M1 Macro: ON (F2)" or "ğŸ–±ï¸ M1 Macro: OFF (F2)"

	if state.m1MacroEnabled then
		disconnect("m1")
		state.connections.m1 = RunService.Heartbeat:Connect(function()
			m1Loop()
			task.wait(state.m1Delay)
		end)
	else
		disconnect("m1")
	end
end

m1Btn.MouseButton1Click:Connect(toggleM1)

autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ğŸ¤– Autofarm: ON" or "ğŸ¤– Autofarm: OFF"
	if state.autofarmEnabled then
		disconnect("autofarm")
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	else
		disconnect("autofarm")
	end
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled
	speedBtn.Text = state.speedEnabled and "ğŸ’¨ Speed: ON" or "ğŸ’¨ Speed: OFF"
	if state.speedEnabled then
		disconnect("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	else
		disconnect("speed")
	end
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "ğŸš€ Infinite Jump: ON" or "ğŸš€ Infinite Jump: OFF"
end)

UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- ===== HOTKEYS =====
UserInputService.InputBegan:Connect(function(input,gpe)
	if gpe then return end
	if input.KeyCode == state.m1Hotkey then
		toggleM1()
	elseif input.KeyCode == state.guiToggleKey then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)
