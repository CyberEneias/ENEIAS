-- ===== AUTOFARM ULTRA-LEVE + GOD MODE + SPEED + INFINITE JUMP + KILLAURA FIRE SERVER =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	NPC_SCAN_INTERVAL = 0.3,
	GUI_NAME = "InfoExperienciaGui",
	COMBO_DELAY = 0.25, -- delay entre ataques para simular M1
	DAMAGE = 8,
	STUN = 0.65,
	RANGE = 5,
	SIZE = Vector3.new(6.5, 5, 6)
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== COMBAT REMOTE =====
local CombatEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("CombatEvent")

-- ===== CACHE =====
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	godModeEnabled = false,
	killauraEnabled = false,
	speedValue = 160,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	connections = {},
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	lastCombo = 0
}

-- ===== UTILS =====
local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== CLEAN GUI =====
local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if oldGui then oldGui:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui")
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false
gui.Parent = CoreGui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2_new(0, 560, 0, 400)
frame.Position = UDim2_new(0.5, -280, 0.5, -200)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0

local frameCorner = Instance.new("UICorner", frame)
frameCorner.CornerRadius = UDim.new(0, 12)

local frameShadow = Instance.new("Frame", frame)
frameShadow.Size = UDim2_new(1,10,1,10)
frameShadow.Position = UDim2_new(0,-5,0,-5)
frameShadow.BackgroundColor3 = Color3.fromRGB(0,0,0)
frameShadow.BackgroundTransparency = 0.85
frameShadow.ZIndex = 0
local shadowCorner = Instance.new("UICorner", frameShadow)
shadowCorner.CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2_new(1,0,0,50)
title.BackgroundTransparency = 1
title.Text = "ðŸ”¥ AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(235,235,235)

-- FunÃ§Ã£o para criar botÃµes estilizados
local function createButton(text, y, width)
	width = width or 220
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2_new(0, width, 0, 45)
	b.Position = UDim2_new(0, 20, 0, y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text

	local corner = Instance.new("UICorner", b)
	corner.CornerRadius = UDim.new(0,8)

	local grad = Instance.new("UIGradient", b)
	grad.Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, Color3.fromRGB(75,95,115)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(60,80,100))
	}

	b.MouseEnter:Connect(function()
		TweenService:Create(b, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(90,110,130)}):Play()
	end)
	b.MouseLeave:Connect(function()
		TweenService:Create(b, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60,80,100)}):Play()
	end)

	return b
end

-- ===== BOTÃ•ES =====
local autofarmBtn = createButton("ðŸ¤– Autofarm: OFF", 60)
local godBtn      = createButton("ðŸ›¡ï¸ God Mode: OFF", 120)
local jumpBtn     = createButton("ðŸš€ Infinite Jump: OFF", 180)
local speedBtn    = createButton("ðŸ’¨ Speed: OFF", 240)
local killauraBtn = createButton("âš”ï¸ Kill Aura: OFF", 300)

local speedBox = Instance.new("TextBox", frame)
speedBox.Size = UDim2_new(0, 100, 0, 35)
speedBox.Position = UDim2_new(1, -130, 0, 245)
speedBox.Text = tostring(state.speedValue)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.BackgroundColor3 = Color3.fromRGB(50,70,90)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.PlaceholderText = "Speed"
local speedCorner = Instance.new("UICorner", speedBox)
speedCorner.CornerRadius = UDim.new(0,6)

local guiKeyBtn = createButton("GUI key ("..state.guiToggleKey.Name..")", 350, 260)
local waitingForKey = false
guiKeyBtn.MouseButton1Click:Connect(function()
	waitingForKey = true
	guiKeyBtn.Text = "Press a key..."
end)

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end
	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {model=npc, root=npcRoot, humanoid=hum, distance=dist})
				end
			end
		end
	end
	table.sort(state.npcCache, function(a,b) return a.distance < b.distance end)
end

local function findClosestNPC()
	if tick() - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = tick()
	end
	return state.npcCache[1] and state.npcCache[1].model
end

-- ===== AUTOFARM LOOP =====
local function autofarmLoop()
	if not state.autofarmEnabled then return end
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end
	if not state.lockedNPC or not state.lockedNPC.Parent then
		state.lockedNPC = findClosestNPC()
	end
	local npc = state.lockedNPC
	if not npc then return end
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end
	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero
	root.CFrame = CFrame_new(
		npcRoot.Position - npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
		+ Vector3_new(0, CONFIG.HEIGHT_OFFSET, 0)
	)
end

-- ===== GOD MODE =====
local function applyGodMode(char)
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if not hum then return end
	hum.BreakJointsOnDeath = false
	hum.RequiresNeck = false
	hum.MaxHealth = math.huge
	hum.Health = hum.MaxHealth
	disconnectConnection("god")
	state.connections.god = hum.HealthChanged:Connect(function()
		if state.godModeEnabled then
			hum.Health = hum.MaxHealth
		end
	end)
end

RunService.Heartbeat:Connect(function()
	if state.godModeEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum.Health = hum.MaxHealth end
	end
end)

-- ===== SPEED =====
local function speedLoop()
	if not state.speedEnabled then return end
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if root and hum and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity =
			hum.MoveDirection.Unit * state.speedValue +
			Vector3_new(0, root.AssemblyLinearVelocity.Y, 0)
	end
end

-- ===== KILLAURA FIRE SERVER =====
local function killAuraLoop()
	if not state.killauraEnabled then return end
	if tick() - state.lastCombo < CONFIG.COMBO_DELAY then return end

	local npc = findClosestNPC()
	if npc and npc.Parent then
		local npcRoot = npc:FindFirstChild("HumanoidRootPart")
		if npcRoot then
			local attackData = {
				HitPart = npcRoot,
				HitPos = npcRoot.Position,
				Damage = CONFIG.DAMAGE,
				Stun = CONFIG.STUN,
				Range = CONFIG.RANGE,
				Size = CONFIG.SIZE,
				AttackType = "M1",
				ComboIndex = 1
			}
			CombatEvent:FireServer(attackData)
			state.lastCombo = tick()
		end
	end
end

state.connections.killaura = RunService.Heartbeat:Connect(killAuraLoop)

-- ===== BUTTON FUNCTIONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ðŸ¤– Autofarm: ON" or "ðŸ¤– Autofarm: OFF"
	if state.autofarmEnabled then
		disconnectConnection("autofarm")
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	else
		disconnectConnection("autofarm")
	end
end)

godBtn.MouseButton1Click:Connect(function()
	state.godModeEnabled = not state.godModeEnabled
	godBtn.Text = state.godModeEnabled and "ðŸ›¡ï¸ God Mode: ON" or "ðŸ›¡ï¸ God Mode: OFF"
	if state.godModeEnabled then
		applyGodMode(player.Character)
	else
		disconnectConnection("god")
	end
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "ðŸš€ Infinite Jump: ON" or "ðŸš€ Infinite Jump: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled
	speedBtn.Text = state.speedEnabled and "ðŸ’¨ Speed: ON" or "ðŸ’¨ Speed: OFF"
	if state.speedEnabled then
		state.speedValue = tonumber(speedBox.Text) or state.speedValue
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	else
		disconnectConnection("speed")
	end
end)

killauraBtn.MouseButton1Click:Connect(function()
	state.killauraEnabled = not state.killauraEnabled
	killauraBtn.Text = state.killauraEnabled and "âš”ï¸ Kill Aura: ON" or "âš”ï¸ Kill Aura: OFF"
end)

-- ===== GUI TOGGLE & TECLA CUSTOM =====
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == state.guiToggleKey then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
	if waitingForKey and input.UserInputType == Enum.UserInputType.Keyboard then
		state.guiToggleKey = input.KeyCode
		guiKeyBtn.Text = "GUI key ("..state.guiToggleKey.Name..")"
		waitingForKey = false
	end
end)

-- ===== INFINITE JUMP =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- ===== CHARACTER ADDED =====
player.CharacterAdded:Connect(function(char)
	task.wait(0.3)
	if state.godModeEnabled then applyGodMode(char) end
	if state.speedEnabled then
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
end)
