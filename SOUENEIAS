-- ===== AUTOFARM + GOD MODE + SPEED + INFINITE JUMP + KILLAURA (SIMULATED COMBAT) =====

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
if not player then return end

-- ===== REMOTE =====
local CombatEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("CombatEvent")

-- ===== CONFIG =====
local COMBAT = {
	Damage = 8,
	Range = 5,
	Size = Vector3.new(6.5, 5, 6),
	Stun = 0.65,
	PunchedTime = 0.1
}

local CONFIG = {
	BACK_DISTANCE = 3,
	HEIGHT_OFFSET = 2,
	MAX_DISTANCE = 8,
	NPC_SCAN_INTERVAL = 0.25,
	KILLAURA_COOLDOWN = 0.1,
	GUI_NAME = "InfoExperienciaGui",
	GUI_KEY = Enum.KeyCode.F1
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarm = false,
	god = false,
	speed = false,
	jump = false,
	killaura = false,

	speedValue = 160,
	guiVisible = true,

	lastScan = 0,
	lastAttack = 0,
	combo = 1,
	formatIndex = nil,

	npcCache = {},
	connections = {}
}

-- ===== UTILS =====
local function disconnect(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== GUI CLEAN =====
local old = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if old then old:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 560, 0, 420)
frame.Position = UDim2.new(0.5, -280, 0.5, -210)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = true
frame.Draggable = true
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,50)
title.BackgroundTransparency = 1
title.Text = "ðŸ”¥ AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(235,235,235)

local function button(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0, 240, 0, 45)
	b.Position = UDim2.new(0, 20, 0, y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local autofarmBtn = button("ðŸ¤– Autofarm: OFF", 60)
local godBtn      = button("ðŸ›¡ï¸ God Mode: OFF", 115)
local jumpBtn     = button("ðŸš€ Infinite Jump: OFF", 170)
local speedBtn    = button("ðŸ’¨ Speed: OFF", 225)
local killauraBtn = button("âš”ï¸ Killaura: OFF", 280)

-- ===== NPC CACHE =====
local function updateNPCs()
	table.clear(state.npcCache)

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChildOfClass("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				if (root.Position - npcRoot.Position).Magnitude <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, npc)
				end
			end
		end
	end
end

local function closestNPC()
	if tick() - state.lastScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCs()
		state.lastScan = tick()
	end
	return state.npcCache[1]
end

-- ===== SIMULATE COMBAT STATE =====
local function simulateState(char)
	if not char then return end

	char:SetAttribute("Attacking", true)
	char:SetAttribute("Blocking", false)
	char:SetAttribute("Stunned", false)
	char:SetAttribute("Combo", state.combo)

	local a = char:FindFirstChild("Attacking") or Instance.new("BoolValue", char)
	a.Name = "Attacking"
	a.Value = true

	local c = char:FindFirstChild("Combo") or Instance.new("IntValue", char)
	c.Name = "Combo"
	c.Value = state.combo
end

-- ===== COMBAT DATA =====
local function nextAction()
	local a = "P_" .. state.combo
	state.combo += 1
	if state.combo > 4 then state.combo = 1 end
	return a
end

local function buildData(root)
	return {
		Damage = COMBAT.Damage,
		Stun = COMBAT.Stun,
		Range = COMBAT.Range,
		Size = COMBAT.Size,
		CFrame = root.CFrame
	}
end

-- ===== FORMAT DETECTION =====
local function detectFormat(npc)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local action = nextAction()
	local data = buildData(root)

	local tests = {
		function() CombatEvent:FireServer(action, data) end,
		function() CombatEvent:FireServer(action, npc) end,
		function() CombatEvent:FireServer(action, npc, data) end,
		function() CombatEvent:FireServer(npc, action, data) end
	}

	for i, fn in ipairs(tests) do
		local ok = pcall(fn)
		if ok then
			state.formatIndex = i
			break
		end
	end
end

local function fireCombat(npc)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	simulateState(char)

	local action = nextAction()
	local data = buildData(root)

	if state.formatIndex == 1 then
		CombatEvent:FireServer(action, data)
	elseif state.formatIndex == 2 then
		CombatEvent:FireServer(action, npc)
	elseif state.formatIndex == 3 then
		CombatEvent:FireServer(action, npc, data)
	elseif state.formatIndex == 4 then
		CombatEvent:FireServer(npc, action, data)
	end
end

-- ===== LOOPS =====
local function autofarmLoop()
	if not state.autofarm then return end
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	local npc = closestNPC()
	if not root or not npc then return end
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	root.CFrame =
		CFrame.new(
			npcRoot.Position - npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
			+ Vector3.new(0, CONFIG.HEIGHT_OFFSET, 0)
		)
end

local function speedLoop()
	if not state.speed then return end
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if root and hum and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity = hum.MoveDirection.Unit * state.speedValue
	end
end

local function killauraLoop()
	if not state.killaura then return end
	if tick() - state.lastAttack < COMBAT.PunchedTime then return end

	local npc = closestNPC()
	if not npc then return end

	if not state.formatIndex then
		detectFormat(npc)
	else
		fireCombat(npc)
	end

	state.lastAttack = tick()
end

-- ===== BUTTONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarm = not state.autofarm
	autofarmBtn.Text = state.autofarm and "ðŸ¤– Autofarm: ON" or "ðŸ¤– Autofarm: OFF"
	disconnect("autofarm")
	if state.autofarm then
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	end
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speed = not state.speed
	speedBtn.Text = state.speed and "ðŸ’¨ Speed: ON" or "ðŸ’¨ Speed: OFF"
	disconnect("speed")
	if state.speed then
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.jump = not state.jump
	jumpBtn.Text = state.jump and "ðŸš€ Infinite Jump: ON" or "ðŸš€ Infinite Jump: OFF"
end)

killauraBtn.MouseButton1Click:Connect(function()
	state.killaura = not state.killaura
	killauraBtn.Text = state.killaura and "âš”ï¸ Killaura: ON" or "âš”ï¸ Killaura: OFF"
	disconnect("killaura")
	if state.killaura then
		state.connections.killaura = RunService.Heartbeat:Connect(killauraLoop)
	end
end)

-- ===== INPUT =====
UserInputService.JumpRequest:Connect(function()
	if state.jump then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

UserInputService.InputBegan:Connect(function(i, g)
	if g then return end
	if i.KeyCode == CONFIG.GUI_KEY then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)
