-- ===== CLEAN + FIEL KILL AURA (M1 SYSTEM) =====

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
if not player then return end

-- CONFIG
local CONFIG = {
	GUI_NAME = "FaithfulKillAura",

	MAX_DISTANCE = 7,
	COMBO_MAX = 4,

	-- tempo realista por combo
	COMBO_COOLDOWN = {
		[1] = 0.28,
		[2] = 0.30,
		[3] = 0.35,
		[4] = 0.45
	},

	DAMAGE = 8,
	STUN = 0.6,
	RANGE = 6,
	SIZE = Vector3.new(6,5,6)
}

-- REMOTES / FOLDERS
local AliveFolder = workspace:WaitForChild("Alive")
local CombatEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("CombatEvent")

-- STATE
local state = {
	killaura = false,
	combo = 1,
	lastAttack = 0
}

-- GUI CLEAN
local old = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if old then old:Destroy() end

-- GUI
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local btn = Instance.new("TextButton", gui)
btn.Size = UDim2.new(0,240,0,50)
btn.Position = UDim2.new(0.5,-120,0.8,0)
btn.Text = "⚔️ Kill Aura: OFF"
btn.Font = Enum.Font.GothamBold
btn.TextSize = 16
btn.BackgroundColor3 = Color3.fromRGB(60,80,100)
btn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", btn).CornerRadius = UDim.new(0,10)

btn.MouseButton1Click:Connect(function()
	state.killaura = not state.killaura
	btn.Text = state.killaura and "⚔️ Kill Aura: ON" or "⚔️ Kill Aura: OFF"
end)

-- UTILS
local function getClosestNPC()
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local closest, distMin

	for _,npc in ipairs(AliveFolder:GetChildren()) do
		local hum = npc:FindFirstChildOfClass("Humanoid")
		local r = npc:FindFirstChild("HumanoidRootPart")
		if hum and r and hum.Health > 0 then
			local d = (root.Position - r.Position).Magnitude
			if d <= CONFIG.MAX_DISTANCE and (not distMin or d < distMin) then
				closest = r
				distMin = d
			end
		end
	end

	return closest
end

-- KILL AURA LOOP (FIEL)
RunService.Heartbeat:Connect(function()
	if not state.killaura then return end

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local targetRoot = getClosestNPC()
	if not targetRoot then return end

	local now = tick()
	local delay = CONFIG.COMBO_COOLDOWN[state.combo] or 0.3
	if now - state.lastAttack < delay then return end

	-- direção e posição coerentes
	local attackData = {
		HitPart = targetRoot,
		HitPos = targetRoot.Position,
		Origin = root.CFrame, -- MUITO importante em vários jogos
		Range = CONFIG.RANGE,
		Size = CONFIG.SIZE,
		Damage = CONFIG.DAMAGE,
		Stun = CONFIG.STUN,
		AttackType = "M1",
		ComboIndex = state.combo
	}

	CombatEvent:FireServer(attackData)

	state.lastAttack = now
	state.combo += 1
	if state.combo > CONFIG.COMBO_MAX then
		state.combo = 1
	end
end)
