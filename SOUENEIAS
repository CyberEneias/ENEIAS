-- ===== FFRE GUI V3 - ULTIMATE EDITION =====
-- Features: ESP, Tracers, Health Bars, Teleport System, Desktop Config Save
-- Compatible with Xeno Executor

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	NPC_SCAN_INTERVAL = 0.3,
	M1_CLICK_DELAY = 0.15,
	CHAR_CACHE_UPDATE = 0.5,
	HEALTH_CHECK_INTERVAL = 0.1,
	GUI_NAME = "FFREStyledGui",
	DESKTOP_PATH = nil, -- Will be set dynamically
	CONFIGS_FOLDER = "FFRE_Configs",
	DEFAULT_CONFIG_NAME = "Default"
}

-- ===== GET DESKTOP PATH =====
local function getDesktopPath()
	if not identifyexecutor then
		return "FFRE_Configs/"
	end
	
	-- Try different methods to get desktop
	local desktopPath = nil
	
	-- Method 1: Environment variable
	pcall(function()
		if os.getenv then
			local userProfile = os.getenv("USERPROFILE")
			if userProfile then
				desktopPath = userProfile .. "\\Desktop\\"
			end
		end
	end)
	
	-- Method 2: Hardcoded common path
	if not desktopPath then
		desktopPath = "C:\\Users\\" .. (os.getenv and os.getenv("USERNAME") or "User") .. "\\Desktop\\"
	end
	
	return desktopPath .. CONFIG.CONFIGS_FOLDER .. "\\"
end

CONFIG.DESKTOP_PATH = getDesktopPath()

-- ===== NPC FOLDER =====
local LiveNPCs = workspace:WaitForChild("LiveNPCS")

-- ===== CACHE =====
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new
local Color3_fromRGB = Color3.fromRGB
local Color3_white = Color3.new(1,1,1)

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	godModeEnabled = false,
	m1MacroEnabled = false,
	espEnabled = false,
	tracersEnabled = false,
	healthBarsEnabled = false,
	speedValue = 160,
	m1ClickDelay = CONFIG.M1_CLICK_DELAY,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	lastM1Click = 0,
	connections = {},
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	charCache = {
		root = nil,
		humanoid = nil,
		character = nil,
		lastUpdate = 0
	},
	lastSpeedApply = 0,
	lastHealthSet = 0,
	currentPage = "combat",
	selectedConfig = nil,
	autoLoadConfig = nil,
	espObjects = {},
	tracerObjects = {},
	healthBarObjects = {}
}

-- ===== CONFIGURATION SYSTEM (DESKTOP) =====
local ConfigSystem = {}

function ConfigSystem.ensureFolder()
	if not isfolder or not makefolder then 
		warn("[CONFIG] File system functions not available")
		return false 
	end
	
	local success = pcall(function()
		if not isfolder(CONFIG.DESKTOP_PATH) then
			makefolder(CONFIG.DESKTOP_PATH)
			print("[CONFIG] Created folder at: " .. CONFIG.DESKTOP_PATH)
		end
	end)
	
	if not success then
		warn("[CONFIG] Failed to create folder at: " .. CONFIG.DESKTOP_PATH)
	end
	
	return success
end

function ConfigSystem.getConfigList()
	if not ConfigSystem.ensureFolder() then return {} end
	if not listfiles then return {} end
	
	local configs = {}
	local success, files = pcall(function()
		return listfiles(CONFIG.DESKTOP_PATH)
	end)
	
	if not success then return {} end
	
	for _, file in ipairs(files) do
		local name = file:match("([^/\\]+)%.json$")
		if name then
			table.insert(configs, name)
		end
	end
	
	table.sort(configs)
	return configs
end

function ConfigSystem.saveConfig(name, settings)
	if not ConfigSystem.ensureFolder() then 
		return false, "File system not available" 
	end
	
	if not writefile then
		return false, "writefile not available"
	end
	
	local success, err = pcall(function()
		local fullPath = CONFIG.DESKTOP_PATH .. name .. ".json"
		local data = HttpService:JSONEncode(settings)
		writefile(fullPath, data)
		print("[CONFIG] Saved to: " .. fullPath)
	end)
	
	return success, err
end

function ConfigSystem.loadConfig(name)
	if not ConfigSystem.ensureFolder() then return nil end
	if not readfile or not isfile then return nil end
	
	local fullPath = CONFIG.DESKTOP_PATH .. name .. ".json"
	
	local fileExists = false
	pcall(function()
		fileExists = isfile(fullPath)
	end)
	
	if not fileExists then 
		warn("[CONFIG] File not found: " .. fullPath)
		return nil 
	end
	
	local success, data = pcall(function()
		local content = readfile(fullPath)
		return HttpService:JSONDecode(content)
	end)
	
	if success then
		print("[CONFIG] Loaded from: " .. fullPath)
	end
	
	return success and data or nil
end

function ConfigSystem.deleteConfig(name)
	if not ConfigSystem.ensureFolder() then return false end
	if not delfile or not isfile then return false end
	
	local fullPath = CONFIG.DESKTOP_PATH .. name .. ".json"
	
	local success = pcall(function()
		if isfile(fullPath) then
			delfile(fullPath)
			print("[CONFIG] Deleted: " .. fullPath)
			return true
		end
	end)
	
	return success
end

function ConfigSystem.getCurrentSettings()
	return {
		speedValue = state.speedValue,
		m1ClickDelay = state.m1ClickDelay,
		guiToggleKey = state.guiToggleKey.Name,
		autofarmEnabled = state.autofarmEnabled,
		godModeEnabled = state.godModeEnabled,
		speedEnabled = state.speedEnabled,
		infiniteJumpEnabled = state.infiniteJumpEnabled,
		m1MacroEnabled = state.m1MacroEnabled,
		espEnabled = state.espEnabled,
		tracersEnabled = state.tracersEnabled,
		healthBarsEnabled = state.healthBarsEnabled,
		timestamp = os.date("%Y-%m-%d %H:%M:%S")
	}
end

function ConfigSystem.applySettings(settings)
	if not settings then return end
	
	state.speedValue = settings.speedValue or state.speedValue
	state.m1ClickDelay = settings.m1ClickDelay or state.m1ClickDelay
	
	-- Will be applied when toggleUpdateFunctions is defined
	task.spawn(function()
		task.wait(0.5)
		if toggleUpdateFunctions then
			if toggleUpdateFunctions.godMode then
				toggleUpdateFunctions.godMode(settings.godModeEnabled == true)
			end
			if toggleUpdateFunctions.autofarm then
				toggleUpdateFunctions.autofarm(settings.autofarmEnabled == true)
			end
			if toggleUpdateFunctions.speed then
				toggleUpdateFunctions.speed(settings.speedEnabled == true)
			end
			if toggleUpdateFunctions.infiniteJump then
				toggleUpdateFunctions.infiniteJump(settings.infiniteJumpEnabled == true)
			end
			if toggleUpdateFunctions.m1Macro then
				toggleUpdateFunctions.m1Macro(settings.m1MacroEnabled == true)
			end
			if toggleUpdateFunctions.esp then
				toggleUpdateFunctions.esp(settings.espEnabled == true)
			end
			if toggleUpdateFunctions.tracers then
				toggleUpdateFunctions.tracers(settings.tracersEnabled == true)
			end
			if toggleUpdateFunctions.healthBars then
				toggleUpdateFunctions.healthBars(settings.healthBarsEnabled == true)
			end
		end
	end)
	
	local keyCode = settings.guiToggleKey and Enum.KeyCode[settings.guiToggleKey]
	if keyCode then
		state.guiToggleKey = keyCode
	end
	
	return true
end

-- ===== UTILS =====
local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

local function cleanAllConnections()
	for name, conn in pairs(state.connections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	table.clear(state.connections)
end

local function getCharComponents()
	local now = tick()
	if now - state.charCache.lastUpdate > CONFIG.CHAR_CACHE_UPDATE then
		local char = player.Character
		state.charCache.character = char
		state.charCache.root = char and char:FindFirstChild("HumanoidRootPart")
		state.charCache.humanoid = char and char:FindFirstChildOfClass("Humanoid")
		state.charCache.lastUpdate = now
	end
	return state.charCache.root, state.charCache.humanoid, state.charCache.character
end

local function invalidateCharCache()
	state.charCache.lastUpdate = 0
end

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local root, _, _ = getCharComponents()
	if not root then return end

	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc ~= player.Character then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {model=npc, root=npcRoot, humanoid=hum, distance=dist})
				end
			end
		end
	end

	table.sort(state.npcCache, function(a,b) return a.distance < b.distance end)
end

local function findClosestNPC()
	local now = tick()
	if now - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = now
	end
	return state.npcCache[1] and state.npcCache[1].model
end

-- ===== ESP SYSTEM =====
local function createESP(npc)
	if state.espObjects[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end
	
	local highlight = Instance.new("Highlight")
	highlight.Name = "FFREHighlight"
	highlight.Adornee = npc
	highlight.FillColor = Color3_fromRGB(255, 0, 0)
	highlight.OutlineColor = Color3_fromRGB(255, 255, 255)
	highlight.FillTransparency = 0.5
	highlight.OutlineTransparency = 0
	highlight.Parent = npc
	
	state.espObjects[npc] = highlight
end

local function removeESP(npc)
	if state.espObjects[npc] then
		state.espObjects[npc]:Destroy()
		state.espObjects[npc] = nil
	end
end

local function clearAllESP()
	for npc, esp in pairs(state.espObjects) do
		if esp then esp:Destroy() end
	end
	table.clear(state.espObjects)
end

-- ===== TRACERS SYSTEM =====
local function createTracer(npc)
	if state.tracerObjects[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end
	
	local beam = Instance.new("Beam")
	beam.Name = "FFRETracer"
	beam.FaceCamera = true
	beam.Color = ColorSequence.new(Color3_fromRGB(0, 255, 0))
	beam.Transparency = NumberSequence.new(0.5)
	beam.Width0 = 0.1
	beam.Width1 = 0.1
	
	local attach0 = Instance.new("Attachment")
	attach0.Parent = workspace.CurrentCamera
	
	local attach1 = Instance.new("Attachment")
	attach1.Parent = npcRoot
	
	beam.Attachment0 = attach0
	beam.Attachment1 = attach1
	beam.Parent = workspace.CurrentCamera
	
	state.tracerObjects[npc] = {beam = beam, attach0 = attach0, attach1 = attach1}
end

local function removeTracer(npc)
	if state.tracerObjects[npc] then
		local data = state.tracerObjects[npc]
		if data.beam then data.beam:Destroy() end
		if data.attach0 then data.attach0:Destroy() end
		if data.attach1 then data.attach1:Destroy() end
		state.tracerObjects[npc] = nil
	end
end

local function clearAllTracers()
	for npc, data in pairs(state.tracerObjects) do
		if data then
			if data.beam then data.beam:Destroy() end
			if data.attach0 then data.attach0:Destroy() end
			if data.attach1 then data.attach1:Destroy() end
		end
	end
	table.clear(state.tracerObjects)
end

-- ===== HEALTH BAR SYSTEM =====
local function createHealthBar(npc)
	if state.healthBarObjects[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	local npcHum = npc:FindFirstChild("Humanoid")
	if not npcRoot or not npcHum then return end
	
	local billboardGui = Instance.new("BillboardGui")
	billboardGui.Name = "FFREHealthBar"
	billboardGui.Adornee = npcRoot
	billboardGui.Size = UDim2_new(4, 0, 0.5, 0)
	billboardGui.StudsOffset = Vector3_new(0, 3, 0)
	billboardGui.AlwaysOnTop = true
	billboardGui.Parent = npc
	
	local frame = Instance.new("Frame")
	frame.Size = UDim2_new(1, 0, 1, 0)
	frame.BackgroundColor3 = Color3_fromRGB(40, 40, 40)
	frame.BorderSizePixel = 0
	frame.Parent = billboardGui
	
	local healthBar = Instance.new("Frame")
	healthBar.Name = "HealthBar"
	healthBar.Size = UDim2_new(npcHum.Health / npcHum.MaxHealth, 0, 1, 0)
	healthBar.BackgroundColor3 = Color3_fromRGB(0, 255, 0)
	healthBar.BorderSizePixel = 0
	healthBar.Parent = frame
	
	local healthText = Instance.new("TextLabel")
	healthText.Name = "HealthText"
	healthText.Size = UDim2_new(1, 0, 1, 0)
	healthText.BackgroundTransparency = 1
	healthText.Text = math.floor(npcHum.Health) .. "/" .. math.floor(npcHum.MaxHealth)
	healthText.TextColor3 = Color3_white
	healthText.TextScaled = true
	healthText.Font = Enum.Font.GothamBold
	healthText.Parent = frame
	
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 4)
	corner.Parent = frame
	
	local corner2 = Instance.new("UICorner")
	corner2.CornerRadius = UDim.new(0, 4)
	corner2.Parent = healthBar
	
	state.healthBarObjects[npc] = billboardGui
end

local function updateHealthBar(npc)
	local healthBarGui = state.healthBarObjects[npc]
	if not healthBarGui then return end
	
	local npcHum = npc:FindFirstChild("Humanoid")
	if not npcHum then return end
	
	local healthBar = healthBarGui:FindFirstChild("Frame"):FindFirstChild("HealthBar")
	local healthText = healthBarGui:FindFirstChild("Frame"):FindFirstChild("HealthText")
	
	if healthBar and healthText then
		local healthPercent = npcHum.Health / npcHum.MaxHealth
		healthBar.Size = UDim2_new(healthPercent, 0, 1, 0)
		healthText.Text = math.floor(npcHum.Health) .. "/" .. math.floor(npcHum.MaxHealth)
		
		-- Color based on health
		if healthPercent > 0.5 then
			healthBar.BackgroundColor3 = Color3_fromRGB(0, 255, 0)
		elseif healthPercent > 0.25 then
			healthBar.BackgroundColor3 = Color3_fromRGB(255, 255, 0)
		else
			healthBar.BackgroundColor3 = Color3_fromRGB(255, 0, 0)
		end
	end
end

local function removeHealthBar(npc)
	if state.healthBarObjects[npc] then
		state.healthBarObjects[npc]:Destroy()
		state.healthBarObjects[npc] = nil
	end
end

local function clearAllHealthBars()
	for npc, gui in pairs(state.healthBarObjects) do
		if gui then gui:Destroy() end
	end
	table.clear(state.healthBarObjects)
end

-- ===== VISUAL FEATURES UPDATE LOOP =====
local function updateVisuals()
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc ~= player.Character then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			
			if hum and npcRoot and hum.Health > 0 then
				-- ESP
				if state.espEnabled then
					createESP(npc)
				else
					removeESP(npc)
				end
				
				-- Tracers
				if state.tracersEnabled then
					createTracer(npc)
				else
					removeTracer(npc)
				end
				
				-- Health Bars
				if state.healthBarsEnabled then
					createHealthBar(npc)
					updateHealthBar(npc)
				else
					removeHealthBar(npc)
				end
			else
				-- Clean up dead NPCs
				removeESP(npc)
				removeTracer(npc)
				removeHealthBar(npc)
			end
		end
	end
end

-- ===== TELEPORT SYSTEM =====
local function teleportToNPC(npcName)
	local root, _, _ = getCharComponents()
	if not root then return false end
	
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc.Name == npcName and npc:IsA("Model") then
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if npcRoot then
				root.CFrame = npcRoot.CFrame * CFrame_new(0, 0, 5)
				return true
			end
		end
	end
	
	return false
end

local function getNPCList()
	local npcList = {}
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
			if not table.find(npcList, npc.Name) then
				table.insert(npcList, npc.Name)
			end
		end
	end
	table.sort(npcList)
	return npcList
end

-- ===== M1 MACRO =====
local function simulateMouseClick()
	local virtualInput = game:GetService("VirtualInputManager")
	virtualInput:SendMouseButtonEvent(0, 0, 0, true, game, 0)
	task.wait(0.01)
	virtualInput:SendMouseButtonEvent(0, 0, 0, false, game, 0)
end

local function m1MacroLoop()
	if not state.m1MacroEnabled then return end
	local now = tick()
	if now - state.lastM1Click >= state.m1ClickDelay then
		pcall(simulateMouseClick)
		state.lastM1Click = now
	end
end

-- ===== AUTOFARM =====
local function isNPCValid(npc)
	if not npc or not npc.Parent then return false end
	local hum = npc:FindFirstChild("Humanoid")
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not hum or not npcRoot or hum.Health <= 0 then return false end
	
	local root, _, _ = getCharComponents()
	if not root then return false end
	
	local dist = (root.Position - npcRoot.Position).Magnitude
	return dist <= CONFIG.MAX_DISTANCE
end

local function autofarmLoop()
	if not state.autofarmEnabled then return end
	local root, _, _ = getCharComponents()
	if not root then return end

	if not isNPCValid(state.lockedNPC) then
		state.lockedNPC = findClosestNPC()
	end

	local npc = state.lockedNPC
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then
		state.lockedNPC = nil
		return
	end

	local npcCFrame = npcRoot.CFrame
	local backVector = -npcCFrame.LookVector * CONFIG.BACK_DISTANCE
	local upVector = Vector3_new(0, CONFIG.HEIGHT_OFFSET, 0)
	local targetCFrame = CFrame_new(npcRoot.Position + backVector + upVector)

	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero
	root.CFrame = targetCFrame
end

-- ===== SPEED BOOST =====
local function speedLoop()
	if not state.speedEnabled then return end
	local root, hum, _ = getCharComponents()
	if root and hum then
		local moveDir = hum.MoveDirection
		if moveDir.Magnitude > 0 then
			local currentY = root.AssemblyLinearVelocity.Y
			root.AssemblyLinearVelocity = (moveDir.Unit * state.speedValue) + Vector3_new(0, currentY, 0)
		end
	end
end

-- ===== GOD MODE =====
local function applyGodMode()
	if not state.godModeEnabled then return end
	local _, hum, _ = getCharComponents()
	if hum and hum.Health > 0 then
		local now = tick()
		if now - state.lastHealthSet > CONFIG.HEALTH_CHECK_INTERVAL then
			hum.Health = hum.MaxHealth
			state.lastHealthSet = now
		end
	end
end

-- ===== CLEANUP OLD GUI =====
pcall(function()
	CoreGui:FindFirstChild(CONFIG.GUI_NAME):Destroy()
end)

-- ===== GUI CREATION =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = CONFIG.GUI_NAME
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = CoreGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2_new(0, 580, 0, 420)
mainFrame.Position = UDim2_new(0.5, -290, 0.5, -210)
mainFrame.BackgroundColor3 = Color3_fromRGB(15, 15, 22)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Header
local header = Instance.new("Frame")
header.Name = "Header"
header.Size = UDim2_new(1, 0, 0, 45)
header.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
header.BorderSizePixel = 0
header.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 12)
headerCorner.Parent = header

local headerBottom = Instance.new("Frame")
headerBottom.Size = UDim2_new(1, 0, 0, 12)
headerBottom.Position = UDim2_new(0, 0, 1, -12)
headerBottom.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
headerBottom.BorderSizePixel = 0
headerBottom.Parent = header

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2_new(1, -100, 1, 0)
titleLabel.Position = UDim2_new(0, 15, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "ğŸ® FFRE GUI V3 - ULTIMATE"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 16
titleLabel.TextColor3 = Color3_white
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = header

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2_new(0, 35, 0, 35)
closeBtn.Position = UDim2_new(1, -40, 0, 5)
closeBtn.BackgroundColor3 = Color3_fromRGB(231, 76, 60)
closeBtn.Text = "Ã—"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 20
closeBtn.TextColor3 = Color3_white
closeBtn.BorderSizePixel = 0
closeBtn.Parent = header

local closeBtnCorner = Instance.new("UICorner")
closeBtnCorner.CornerRadius = UDim.new(0, 8)
closeBtnCorner.Parent = closeBtn

closeBtn.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

-- Tabs Container
local tabsContainer = Instance.new("Frame")
tabsContainer.Size = UDim2_new(1, -20, 0, 35)
tabsContainer.Position = UDim2_new(0, 10, 0, 55)
tabsContainer.BackgroundTransparency = 1
tabsContainer.Parent = mainFrame

local tabsLayout = Instance.new("UIListLayout")
tabsLayout.FillDirection = Enum.FillDirection.Horizontal
tabsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
tabsLayout.Padding = UDim.new(0, 5)
tabsLayout.Parent = tabsContainer

-- Helper function for creating tabs
local function createTab(parent, text)
	local tab = Instance.new("TextButton")
	tab.Size = UDim2_new(0, 120, 0, 35)
	tab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	tab.Text = text
	tab.Font = Enum.Font.GothamBold
	tab.TextSize = 13
	tab.TextColor3 = Color3_fromRGB(180, 180, 190)
	tab.BorderSizePixel = 0
	tab.AutoButtonColor = false
	tab.Parent = parent
	
	local tabCorner = Instance.new("UICorner")
	tabCorner.CornerRadius = UDim.new(0, 8)
	tabCorner.Parent = tab
	
	return tab
end

-- Create Tabs
local combatTab = createTab(tabsContainer, "âš”ï¸ Combat")
local visualTab = createTab(tabsContainer, "ğŸ‘ï¸ Visual")
local teleportTab = createTab(tabsContainer, "ğŸ“ Teleport")
local configsTab = createTab(tabsContainer, "âš™ï¸ Configs")

-- Content Container
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2_new(1, -20, 1, -105)
contentFrame.Position = UDim2_new(0, 10, 0, 95)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- Combat Page
local combatPage = Instance.new("ScrollingFrame")
combatPage.Name = "CombatPage"
combatPage.Size = UDim2_new(1, 0, 1, 0)
combatPage.BackgroundTransparency = 1
combatPage.BorderSizePixel = 0
combatPage.ScrollBarThickness = 5
combatPage.ScrollBarImageColor3 = Color3_fromRGB(80, 80, 120)
combatPage.CanvasSize = UDim2_new(0, 0, 0, 0)
combatPage.AutomaticCanvasSize = Enum.AutomaticSize.Y
combatPage.Parent = contentFrame

local combatLayout = Instance.new("UIListLayout")
combatLayout.Padding = UDim.new(0, 10)
combatLayout.SortOrder = Enum.SortOrder.LayoutOrder
combatLayout.Parent = combatPage

-- Visual Page
local visualPage = Instance.new("ScrollingFrame")
visualPage.Name = "VisualPage"
visualPage.Size = UDim2_new(1, 0, 1, 0)
visualPage.BackgroundTransparency = 1
visualPage.BorderSizePixel = 0
visualPage.ScrollBarThickness = 5
visualPage.ScrollBarImageColor3 = Color3_fromRGB(80, 80, 120)
visualPage.CanvasSize = UDim2_new(0, 0, 0, 0)
visualPage.AutomaticCanvasSize = Enum.AutomaticSize.Y
visualPage.Visible = false
visualPage.Parent = contentFrame

local visualLayout = Instance.new("UIListLayout")
visualLayout.Padding = UDim.new(0, 10)
visualLayout.SortOrder = Enum.SortOrder.LayoutOrder
visualLayout.Parent = visualPage

-- Teleport Page
local teleportPage = Instance.new("ScrollingFrame")
teleportPage.Name = "TeleportPage"
teleportPage.Size = UDim2_new(1, 0, 1, 0)
teleportPage.BackgroundTransparency = 1
teleportPage.BorderSizePixel = 0
teleportPage.ScrollBarThickness = 5
teleportPage.ScrollBarImageColor3 = Color3_fromRGB(80, 80, 120)
teleportPage.CanvasSize = UDim2_new(0, 0, 0, 0)
teleportPage.AutomaticCanvasSize = Enum.AutomaticSize.Y
teleportPage.Visible = false
teleportPage.Parent = contentFrame

local teleportLayout = Instance.new("UIListLayout")
teleportLayout.Padding = UDim.new(0, 8)
teleportLayout.SortOrder = Enum.SortOrder.LayoutOrder
teleportLayout.Parent = teleportPage

-- Configs Page
local configsPage = Instance.new("ScrollingFrame")
configsPage.Name = "ConfigsPage"
configsPage.Size = UDim2_new(1, 0, 1, 0)
configsPage.BackgroundTransparency = 1
configsPage.BorderSizePixel = 0
configsPage.ScrollBarThickness = 5
configsPage.ScrollBarImageColor3 = Color3_fromRGB(80, 80, 120)
configsPage.CanvasSize = UDim2_new(0, 0, 0, 0)
configsPage.AutomaticCanvasSize = Enum.AutomaticSize.Y
configsPage.Visible = false
configsPage.Parent = contentFrame

local configsLayout = Instance.new("UIListLayout")
configsLayout.Padding = UDim.new(0, 10)
configsLayout.SortOrder = Enum.SortOrder.LayoutOrder
configsLayout.Parent = configsPage

-- Tab switching
local currentPage = combatPage

local function switchToPage(page, tab)
	combatPage.Visible = false
	visualPage.Visible = false
	teleportPage.Visible = false
	configsPage.Visible = false
	
	combatTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	combatTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	visualTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	visualTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	teleportTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	teleportTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	configsTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	configsTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	
	page.Visible = true
	tab.BackgroundColor3 = Color3_fromRGB(52, 152, 219)
	tab.TextColor3 = Color3_white
	currentPage = page
end

combatTab.MouseButton1Click:Connect(function()
	switchToPage(combatPage, combatTab)
end)

visualTab.MouseButton1Click:Connect(function()
	switchToPage(visualPage, visualTab)
end)

teleportTab.MouseButton1Click:Connect(function()
	switchToPage(teleportPage, teleportTab)
end)

configsTab.MouseButton1Click:Connect(function()
	switchToPage(configsPage, configsTab)
end)

-- Initialize combat tab as selected
switchToPage(combatPage, combatTab)

-- Helper function to create toggle button
local function createToggleButton(parent, labelText, defaultState)
	local container = Instance.new("Frame")
	container.Size = UDim2_new(1, -10, 0, 40)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	container.Parent = parent
	
	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 8)
	containerCorner.Parent = container
	
	local label = Instance.new("TextLabel")
	label.Size = UDim2_new(0.7, -10, 1, 0)
	label.Position = UDim2_new(0, 10, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = labelText
	label.Font = Enum.Font.Gotham
	label.TextSize = 13
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = container
	
	local toggle = Instance.new("TextButton")
	toggle.Size = UDim2_new(0, 80, 0, 30)
	toggle.Position = UDim2_new(1, -90, 0.5, -15)
	toggle.BackgroundColor3 = defaultState and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	toggle.Text = defaultState and "ON" or "OFF"
	toggle.Font = Enum.Font.GothamBold
	toggle.TextSize = 12
	toggle.TextColor3 = Color3_white
	toggle.BorderSizePixel = 0
	toggle.AutoButtonColor = false
	toggle.Parent = container
	
	local toggleCorner = Instance.new("UICorner")
	toggleCorner.CornerRadius = UDim.new(0, 6)
	toggleCorner.Parent = toggle
	
	return container, toggle
end

-- Helper function to create input field
local function createInputField(parent, labelText, placeholderText, defaultValue)
	local container = Instance.new("Frame")
	container.Size = UDim2_new(1, -10, 0, 60)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	container.Parent = parent
	
	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 8)
	containerCorner.Parent = container
	
	local label = Instance.new("TextLabel")
	label.Size = UDim2_new(1, -20, 0, 20)
	label.Position = UDim2_new(0, 10, 0, 5)
	label.BackgroundTransparency = 1
	label.Text = labelText
	label.Font = Enum.Font.GothamBold
	label.TextSize = 13
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = container
	
	local input = Instance.new("TextBox")
	input.Size = UDim2_new(1, -20, 0, 30)
	input.Position = UDim2_new(0, 10, 0, 25)
	input.BackgroundColor3 = Color3_fromRGB(30, 30, 40)
	input.PlaceholderText = placeholderText
	input.Text = defaultValue or ""
	input.Font = Enum.Font.Gotham
	input.TextSize = 12
	input.TextColor3 = Color3_white
	input.BorderSizePixel = 0
	input.ClearTextOnFocus = false
	input.Parent = container
	
	local inputCorner = Instance.new("UICorner")
	inputCorner.CornerRadius = UDim.new(0, 6)
	inputCorner.Parent = input
	
	return container, input
end

-- ===== COMBAT PAGE ELEMENTS =====

-- Autofarm
local autofarmContainer, autofarmToggle = createToggleButton(combatPage, "ğŸ¤– Auto Farm", state.autofarmEnabled)

-- God Mode
local godModeContainer, godModeToggle = createToggleButton(combatPage, "ğŸ’ God Mode", state.godModeEnabled)

-- Speed
local speedContainer, speedToggle = createToggleButton(combatPage, "âš¡ Speed Boost", state.speedEnabled)
local speedInputContainer, speedInput = createInputField(combatPage, "Speed Value", "Enter speed (e.g., 160)", tostring(state.speedValue))

-- Infinite Jump
local jumpContainer, jumpToggle = createToggleButton(combatPage, "ğŸš€ Infinite Jump", state.infiniteJumpEnabled)

-- M1 Macro
local m1Container, m1Toggle = createToggleButton(combatPage, "ğŸ–±ï¸ M1 Auto Click (F2)", state.m1MacroEnabled)
local m1InputContainer, m1Input = createInputField(combatPage, "M1 Click Delay (seconds)", "Enter delay (e.g., 0.15)", tostring(state.m1ClickDelay))

-- ===== VISUAL PAGE ELEMENTS =====

-- ESP
local espContainer, espToggle = createToggleButton(visualPage, "ğŸ‘ï¸ ESP (See NPCs)", state.espEnabled)

-- Tracers
local tracersContainer, tracersToggle = createToggleButton(visualPage, "ğŸ“ Tracers (Lines to NPCs)", state.tracersEnabled)

-- Health Bars
local healthBarsContainer, healthBarsToggle = createToggleButton(visualPage, "â¤ï¸ Health Bars", state.healthBarsEnabled)

-- ===== TELEPORT PAGE ELEMENTS =====

-- Info Label
local tpInfoContainer = Instance.new("Frame")
tpInfoContainer.Size = UDim2_new(1, -10, 0, 50)
tpInfoContainer.BackgroundColor3 = Color3_fromRGB(41, 128, 185)
tpInfoContainer.BorderSizePixel = 0
tpInfoContainer.Parent = teleportPage

local tpInfoCorner = Instance.new("UICorner")
tpInfoCorner.CornerRadius = UDim.new(0, 8)
tpInfoCorner.Parent = tpInfoContainer

local tpInfoLabel = Instance.new("TextLabel")
tpInfoLabel.Size = UDim2_new(1, -20, 1, 0)
tpInfoLabel.Position = UDim2_new(0, 10, 0, 0)
tpInfoLabel.BackgroundTransparency = 1
tpInfoLabel.Text = "ğŸ“ Click on any NPC below to teleport"
tpInfoLabel.Font = Enum.Font.GothamBold
tpInfoLabel.TextSize = 14
tpInfoLabel.TextColor3 = Color3_white
tpInfoLabel.TextXAlignment = Enum.TextXAlignment.Left
tpInfoLabel.TextWrapped = true
tpInfoLabel.Parent = tpInfoContainer

-- Refresh NPCs Button
local refreshNPCBtn = Instance.new("TextButton")
refreshNPCBtn.Size = UDim2_new(1, -10, 0, 40)
refreshNPCBtn.BackgroundColor3 = Color3_fromRGB(46, 204, 113)
refreshNPCBtn.Text = "ğŸ”„ Refresh NPC List"
refreshNPCBtn.Font = Enum.Font.GothamBold
refreshNPCBtn.TextSize = 14
refreshNPCBtn.TextColor3 = Color3_white
refreshNPCBtn.BorderSizePixel = 0
refreshNPCBtn.AutoButtonColor = false
refreshNPCBtn.Parent = teleportPage

local refreshNPCCorner = Instance.new("UICorner")
refreshNPCCorner.CornerRadius = UDim.new(0, 8)
refreshNPCCorner.Parent = refreshNPCBtn

-- NPC List Container
local npcListContainer = Instance.new("Frame")
npcListContainer.Name = "NPCListContainer"
npcListContainer.Size = UDim2_new(1, -10, 0, 0)
npcListContainer.AutomaticSize = Enum.AutomaticSize.Y
npcListContainer.BackgroundTransparency = 1
npcListContainer.Parent = teleportPage

local npcListLayout = Instance.new("UIListLayout")
npcListLayout.Padding = UDim.new(0, 5)
npcListLayout.SortOrder = Enum.SortOrder.LayoutOrder
npcListLayout.Parent = npcListContainer

-- Function to populate NPC list
local function populateNPCList()
	-- Clear existing
	for _, child in ipairs(npcListContainer:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end
	
	local npcList = getNPCList()
	
	for _, npcName in ipairs(npcList) do
		local npcBtn = Instance.new("TextButton")
		npcBtn.Size = UDim2_new(1, 0, 0, 35)
		npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
		npcBtn.Text = "ğŸ“Œ " .. npcName
		npcBtn.Font = Enum.Font.Gotham
		npcBtn.TextSize = 13
		npcBtn.TextColor3 = Color3_white
		npcBtn.TextXAlignment = Enum.TextXAlignment.Left
		npcBtn.BorderSizePixel = 0
		npcBtn.AutoButtonColor = false
		npcBtn.Parent = npcListContainer
		
		local npcBtnPadding = Instance.new("UIPadding")
		npcBtnPadding.PaddingLeft = UDim.new(0, 10)
		npcBtnPadding.Parent = npcBtn
		
		local npcBtnCorner = Instance.new("UICorner")
		npcBtnCorner.CornerRadius = UDim.new(0, 6)
		npcBtnCorner.Parent = npcBtn
		
		npcBtn.MouseEnter:Connect(function()
			npcBtn.BackgroundColor3 = Color3_fromRGB(30, 30, 40)
		end)
		
		npcBtn.MouseLeave:Connect(function()
			npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
		end)
		
		npcBtn.MouseButton1Click:Connect(function()
			local success = teleportToNPC(npcName)
			if success then
				npcBtn.BackgroundColor3 = Color3_fromRGB(46, 204, 113)
				task.wait(0.3)
				npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
			else
				npcBtn.BackgroundColor3 = Color3_fromRGB(231, 76, 60)
				task.wait(0.3)
				npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
			end
		end)
	end
end

refreshNPCBtn.MouseButton1Click:Connect(populateNPCList)

-- Initial population
task.spawn(function()
	task.wait(1)
	populateNPCList()
end)

-- ===== CONFIGS PAGE ELEMENTS =====

-- Config Save Path Info
local configPathContainer = Instance.new("Frame")
configPathContainer.Size = UDim2_new(1, -10, 0, 70)
configPathContainer.BackgroundColor3 = Color3_fromRGB(41, 128, 185)
configPathContainer.BorderSizePixel = 0
configPathContainer.Parent = configsPage

local configPathCorner = Instance.new("UICorner")
configPathCorner.CornerRadius = UDim.new(0, 8)
configPathCorner.Parent = configPathContainer

local configPathTitle = Instance.new("TextLabel")
configPathTitle.Size = UDim2_new(1, -20, 0, 20)
configPathTitle.Position = UDim2_new(0, 10, 0, 5)
configPathTitle.BackgroundTransparency = 1
configPathTitle.Text = "ğŸ’¾ Configs Save Location:"
configPathTitle.Font = Enum.Font.GothamBold
configPathTitle.TextSize = 13
configPathTitle.TextColor3 = Color3_white
configPathTitle.TextXAlignment = Enum.TextXAlignment.Left
configPathTitle.Parent = configPathContainer

local configPathLabel = Instance.new("TextLabel")
configPathLabel.Size = UDim2_new(1, -20, 0, 40)
configPathLabel.Position = UDim2_new(0, 10, 0, 25)
configPathLabel.BackgroundTransparency = 1
configPathLabel.Text = CONFIG.DESKTOP_PATH
configPathLabel.Font = Enum.Font.Gotham
configPathLabel.TextSize = 11
configPathLabel.TextColor3 = Color3_fromRGB(230, 230, 240)
configPathLabel.TextXAlignment = Enum.TextXAlignment.Left
configPathLabel.TextWrapped = true
configPathLabel.Parent = configPathContainer

-- Config Name Input
local configNameContainer, configNameInput = createInputField(configsPage, "Config Name", "Enter configuration name...")

-- Config Buttons Container
local configBtnsContainer = Instance.new("Frame")
configBtnsContainer.Size = UDim2_new(1, -10, 0, 140)
configBtnsContainer.BackgroundTransparency = 1
configBtnsContainer.Parent = configsPage

local configBtnsLayout = Instance.new("UIGridLayout")
configBtnsLayout.CellSize = UDim2_new(0.48, 0, 0, 35)
configBtnsLayout.CellPadding = UDim2_new(0.04, 0, 0, 8)
configBtnsLayout.SortOrder = Enum.SortOrder.LayoutOrder
configBtnsLayout.Parent = configBtnsContainer

-- Helper to create config button
local function createConfigButton(parent, text, color)
	local btn = Instance.new("TextButton")
	btn.BackgroundColor3 = color
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 13
	btn.TextColor3 = Color3_white
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	btn.Parent = parent
	
	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(0, 8)
	btnCorner.Parent = btn
	
	return btn
end

local createConfigBtn = createConfigButton(configBtnsContainer, "â• Create", Color3_fromRGB(46, 204, 113))
local loadConfigBtn = createConfigButton(configBtnsContainer, "ğŸ“‚ Load", Color3_fromRGB(52, 152, 219))
local overwriteConfigBtn = createConfigButton(configBtnsContainer, "âœï¸ Overwrite", Color3_fromRGB(230, 126, 34))
local refreshConfigBtn = createConfigButton(configBtnsContainer, "ğŸ”„ Refresh", Color3_fromRGB(149, 165, 166))

-- Config List Container
local configListTitle = Instance.new("TextLabel")
configListTitle.Size = UDim2_new(1, -10, 0, 25)
configListTitle.BackgroundTransparency = 1
configListTitle.Text = "ğŸ“‹ Saved Configurations:"
configListTitle.Font = Enum.Font.GothamBold
configListTitle.TextSize = 13
configListTitle.TextColor3 = Color3_white
configListTitle.TextXAlignment = Enum.TextXAlignment.Left
configListTitle.Parent = configsPage

local configListContainer = Instance.new("Frame")
configListContainer.Name = "ConfigListContainer"
configListContainer.Size = UDim2_new(1, -10, 0, 0)
configListContainer.AutomaticSize = Enum.AutomaticSize.Y
configListContainer.BackgroundTransparency = 1
configListContainer.Parent = configsPage

local configListLayout = Instance.new("UIListLayout")
configListLayout.Padding = UDim.new(0, 5)
configListLayout.SortOrder = Enum.SortOrder.LayoutOrder
configListLayout.Parent = configListContainer

-- Message display
local messageLabel = Instance.new("TextLabel")
messageLabel.Name = "MessageLabel"
messageLabel.Size = UDim2_new(1, -10, 0, 0)
messageLabel.BackgroundTransparency = 1
messageLabel.Text = ""
messageLabel.Font = Enum.Font.GothamBold
messageLabel.TextSize = 12
messageLabel.TextColor3 = Color3_fromRGB(100, 255, 100)
messageLabel.TextXAlignment = Enum.TextXAlignment.Center
messageLabel.TextWrapped = true
messageLabel.Visible = false
messageLabel.Parent = configsPage

local function showMessage(text, color)
	messageLabel.Text = text
	messageLabel.TextColor3 = color
	messageLabel.Visible = true
	messageLabel.Size = UDim2_new(1, -10, 0, 30)
	task.wait(3)
	messageLabel.Visible = false
	messageLabel.Size = UDim2_new(1, -10, 0, 0)
end

-- Function to update config list
local function updateConfigList()
	-- Clear existing
	for _, child in ipairs(configListContainer:GetChildren()) do
		if child:IsA("Frame") and child.Name ~= "UIListLayout" then
			child:Destroy()
		end
	end
	
	local configs = ConfigSystem.getConfigList()
	
	for _, configName in ipairs(configs) do
		local configItem = Instance.new("Frame")
		configItem.Size = UDim2_new(1, 0, 0, 35)
		configItem.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
		configItem.BorderSizePixel = 0
		configItem.Parent = configListContainer
		
		local configItemCorner = Instance.new("UICorner")
		configItemCorner.CornerRadius = UDim.new(0, 6)
		configItemCorner.Parent = configItem
		
		local configItemBtn = Instance.new("TextButton")
		configItemBtn.Size = UDim2_new(0.7, 0, 1, 0)
		configItemBtn.Position = UDim2_new(0, 10, 0, 0)
		configItemBtn.BackgroundTransparency = 1
		configItemBtn.Text = "ğŸ“„ " .. configName
		configItemBtn.Font = Enum.Font.Gotham
		configItemBtn.TextSize = 12
		configItemBtn.TextColor3 = Color3_white
		configItemBtn.TextXAlignment = Enum.TextXAlignment.Left
		configItemBtn.AutoButtonColor = false
		configItemBtn.Parent = configItem
		
		local deleteBtn = Instance.new("TextButton")
		deleteBtn.Size = UDim2_new(0, 60, 0, 25)
		deleteBtn.Position = UDim2_new(1, -70, 0.5, -12.5)
		deleteBtn.BackgroundColor3 = Color3_fromRGB(231, 76, 60)
		deleteBtn.Text = "ğŸ—‘ï¸ Delete"
		deleteBtn.Font = Enum.Font.GothamBold
		deleteBtn.TextSize = 11
		deleteBtn.TextColor3 = Color3_white
		deleteBtn.BorderSizePixel = 0
		deleteBtn.AutoButtonColor = false
		deleteBtn.Parent = configItem
		
		local deleteBtnCorner = Instance.new("UICorner")
		deleteBtnCorner.CornerRadius = UDim.new(0, 6)
		deleteBtnCorner.Parent = deleteBtn
		
		-- Select config
		configItemBtn.MouseButton1Click:Connect(function()
			state.selectedConfig = configName
			configNameInput.Text = configName
			
			-- Visual feedback
			for _, item in ipairs(configListContainer:GetChildren()) do
				if item:IsA("Frame") then
					item.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
				end
			end
			configItem.BackgroundColor3 = Color3_fromRGB(52, 152, 219)
		end)
		
		-- Delete config
		deleteBtn.MouseButton1Click:Connect(function()
			if ConfigSystem.deleteConfig(configName) then
				showMessage("âœ… Config '" .. configName .. "' deleted!", Color3_fromRGB(100, 255, 100))
				updateConfigList()
				if state.selectedConfig == configName then
					state.selectedConfig = nil
					configNameInput.Text = ""
				end
			else
				showMessage("âŒ Failed to delete config!", Color3_fromRGB(255, 100, 100))
			end
		end)
	end
end

-- Config button actions
createConfigBtn.MouseButton1Click:Connect(function()
	local configName = configNameInput.Text:gsub("%s+", " "):gsub("^%s*(.-)%s*$", "%1")
	
	if configName == "" then
		showMessage("âš ï¸ Please enter a configuration name!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	if configName:match("[^%w%s%-_]") then
		showMessage("âš ï¸ Invalid name! Use only letters, numbers, spaces, hyphens and underscores.", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local success, err = ConfigSystem.saveConfig(configName, ConfigSystem.getCurrentSettings())
	
	if success then
		showMessage("âœ… Configuration '" .. configName .. "' saved!", Color3_fromRGB(100, 255, 100))
		state.selectedConfig = configName
		updateConfigList()
		configNameInput.Text = ""
	else
		showMessage("âŒ Failed to save: " .. tostring(err), Color3_fromRGB(255, 100, 100))
	end
end)

loadConfigBtn.MouseButton1Click:Connect(function()
	if not state.selectedConfig then
		showMessage("âš ï¸ Please select a configuration first!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local settings = ConfigSystem.loadConfig(state.selectedConfig)
	
	if settings then
		ConfigSystem.applySettings(settings)
		showMessage("âœ… Configuration '" .. state.selectedConfig .. "' loaded!", Color3_fromRGB(100, 255, 100))
	else
		showMessage("âŒ Failed to load configuration!", Color3_fromRGB(255, 100, 100))
	end
end)

overwriteConfigBtn.MouseButton1Click:Connect(function()
	if not state.selectedConfig then
		showMessage("âš ï¸ Please select a configuration to overwrite!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local success, err = ConfigSystem.saveConfig(state.selectedConfig, ConfigSystem.getCurrentSettings())
	
	if success then
		showMessage("âœ… Configuration '" .. state.selectedConfig .. "' overwritten!", Color3_fromRGB(100, 255, 100))
	else
		showMessage("âŒ Failed to overwrite: " .. tostring(err), Color3_fromRGB(255, 100, 100))
	end
end)

refreshConfigBtn.MouseButton1Click:Connect(function()
	updateConfigList()
	showMessage("âœ… Configuration list refreshed!", Color3_fromRGB(100, 255, 100))
end)

-- Initial config list update
task.spawn(function()
	task.wait(1)
	updateConfigList()
end)

-- ===== TOGGLE UPDATE FUNCTIONS =====
toggleUpdateFunctions = {}

-- Autofarm
toggleUpdateFunctions.autofarm = function(enabled)
	state.autofarmEnabled = enabled
	autofarmToggle.Text = enabled and "ON" or "OFF"
	autofarmToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if enabled then
		disconnectConnection("autofarm")
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	else
		disconnectConnection("autofarm")
		state.lockedNPC = nil
	end
end

autofarmToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.autofarm(not state.autofarmEnabled)
end)

-- God Mode
toggleUpdateFunctions.godMode = function(enabled)
	state.godModeEnabled = enabled
	godModeToggle.Text = enabled and "ON" or "OFF"
	godModeToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if enabled then
		disconnectConnection("godmode")
		state.connections.godmode = RunService.Heartbeat:Connect(applyGodMode)
	else
		disconnectConnection("godmode")
	end
end

godModeToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.godMode(not state.godModeEnabled)
end)

-- Speed
toggleUpdateFunctions.speed = function(enabled)
	state.speedEnabled = enabled
	speedToggle.Text = enabled and "ON" or "OFF"
	speedToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if enabled then
		local value = tonumber(speedInput.Text)
		if value and value > 0 then
			state.speedValue = value
		end
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	else
		disconnectConnection("speed")
	end
end

speedToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.speed(not state.speedEnabled)
end)

speedInput.FocusLost:Connect(function()
	local value = tonumber(speedInput.Text)
	if value and value > 0 then
		state.speedValue = value
	end
end)

-- Infinite Jump
toggleUpdateFunctions.infiniteJump = function(enabled)
	state.infiniteJumpEnabled = enabled
	jumpToggle.Text = enabled and "ON" or "OFF"
	jumpToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
end

jumpToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.infiniteJump(not state.infiniteJumpEnabled)
end)

-- M1 Macro
toggleUpdateFunctions.m1Macro = function(enabled)
	state.m1MacroEnabled = enabled
	m1Toggle.Text = enabled and "ON" or "OFF"
	m1Toggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if enabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	else
		disconnectConnection("m1macro")
	end
end

m1Toggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.m1Macro(not state.m1MacroEnabled)
end)

m1Input.FocusLost:Connect(function()
	local value = tonumber(m1Input.Text)
	if value and value > 0 then
		state.m1ClickDelay = value
	end
end)

-- ESP
toggleUpdateFunctions.esp = function(enabled)
	state.espEnabled = enabled
	espToggle.Text = enabled and "ON" or "OFF"
	espToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if not enabled then
		clearAllESP()
	end
end

espToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.esp(not state.espEnabled)
end)

-- Tracers
toggleUpdateFunctions.tracers = function(enabled)
	state.tracersEnabled = enabled
	tracersToggle.Text = enabled and "ON" or "OFF"
	tracersToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if not enabled then
		clearAllTracers()
	end
end

tracersToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.tracers(not state.tracersEnabled)
end)

-- Health Bars
toggleUpdateFunctions.healthBars = function(enabled)
	state.healthBarsEnabled = enabled
	healthBarsToggle.Text = enabled and "ON" or "OFF"
	healthBarsToggle.BackgroundColor3 = enabled and Color3_fromRGB(46, 204, 113) or Color3_fromRGB(52, 73, 94)
	
	if not enabled then
		clearAllHealthBars()
	end
end

healthBarsToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.healthBars(not state.healthBarsEnabled)
end)

-- ===== VISUAL FEATURES LOOP =====
state.connections.visualUpdate = RunService.Heartbeat:Connect(updateVisuals)

-- ===== INPUT HANDLING =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local _, hum, _ = getCharComponents()
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end

	if input.KeyCode == Enum.KeyCode.F1 then
		state.guiVisible = not state.guiVisible
		mainFrame.Visible = state.guiVisible
	end

	if input.KeyCode == Enum.KeyCode.F2 then
		toggleUpdateFunctions.m1Macro(not state.m1MacroEnabled)
	end
end)

-- ===== CHARACTER EVENTS =====
player.CharacterAdded:Connect(function(char)
	invalidateCharCache()
	task.wait(0.3)
	
	if state.speedEnabled then
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
	if state.m1MacroEnabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	end
	if state.godModeEnabled then
		disconnectConnection("godmode")
		state.connections.godmode = RunService.Heartbeat:Connect(applyGodMode)
	end
end)

-- ===== CLEANUP =====
screenGui.Destroying:Connect(function()
	cleanAllConnections()
	clearAllESP()
	clearAllTracers()
	clearAllHealthBars()
end)

-- ===== STARTUP MESSAGE =====
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  FFRE GUI V3 - ULTIMATE EDITION")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  âš”ï¸ Combat Features:")
print("    â€¢ Auto Farm")
print("    â€¢ God Mode")
print("    â€¢ Speed Boost")
print("    â€¢ Infinite Jump")
print("    â€¢ M1 Auto Click")
print("  ğŸ‘ï¸ Visual Features:")
print("    â€¢ ESP (Highlights)")
print("    â€¢ Tracers (Lines)")
print("    â€¢ Health Bars")
print("  ğŸ“ Teleport System:")
print("    â€¢ Teleport to any NPC")
print("  âš™ï¸ Configuration System:")
print("    â€¢ Save/Load configs")
print("    â€¢ Desktop storage: " .. CONFIG.DESKTOP_PATH)
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  Keybinds:")
print("    F1 - Toggle GUI")
print("    F2 - Toggle M1 Macro")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
