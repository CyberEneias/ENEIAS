-- ===== SERVICES =====
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")

-- ===== PLAYER =====
local player = Players.LocalPlayer
if not player then return end

-- ===== REMOTES =====
local Events = ReplicatedStorage:WaitForChild("Events")
local CombatEvent = Events:WaitForChild("CombatEvent")
local ResetComboEvent = Events:WaitForChild("ResetComboEvent")

-- ===== GLOBAL COMBO =====
_G.Clicked = 1
_G.GCD = false
_G.FistDisabled = false

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	killAuraEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	speedValue = 160,
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1
}

-- ===== CLEAN GUI =====
local oldGui = CoreGui:FindFirstChild("InfoExperienciaGui")
if oldGui then oldGui:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = "InfoExperienciaGui"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 580, 0, 440)
frame.Position = UDim2.new(0.5, -290, 0.5, -220)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.BorderSizePixel = 0
frame.Active = false
frame.ZIndex = 1
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local function createButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0,240,0,45)
	b.Position = UDim2.new(0,20,0,y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	b.AutoButtonColor = true
	b.ZIndex = 2
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local autofarmBtn = createButton("ğŸ¤– Autofarm: OFF", 60)
local auraBtn     = createButton("ğŸ—¡ï¸ Kill Aura: OFF", 120)
local jumpBtn     = createButton("ğŸš€ Infinite Jump: OFF", 180)
local speedBtn    = createButton("ğŸ’¨ Speed: OFF", 240)

-- ===== SPEED BOX =====
local speedBox = Instance.new("TextBox", frame)
speedBox.Size = UDim2.new(0,100,0,35)
speedBox.Position = UDim2.new(1,-130,0,245)
speedBox.Text = tostring(state.speedValue)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.BackgroundColor3 = Color3.fromRGB(50,70,90)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.ClearTextOnFocus = false
speedBox.ZIndex = 2
Instance.new("UICorner", speedBox).CornerRadius = UDim.new(0,6)

-- ===== WEAPON INFO =====
local WeaponInfoFolder = script:WaitForChild("WeaponInfoFolder")

-- ===== COMBAT (100% ORIGINAL) =====
local Attacking = false
local UsingAttack = false

local function CanAttack()
	if _G.FistDisabled then return end
	if Attacking then return end
	if _G.GCD then return end

	local char = player.Character
	if not char then return end

	if char:FindFirstChildOfClass("Tool") then return end
	for _,v in ipairs({"Stun","Parried","Knocked","TempKnocked","Carried","UsingMove"}) do
		if char:FindFirstChild(v) then return end
	end

	return true
end

local function DoAttack()
	if not CanAttack() then return end

	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not hum or not root then return end

	Attacking = true
	UsingAttack = true
	_G.GCD = true

	local weapon = WeaponInfoFolder.Fist
	if char:FindFirstChild("WeaponEquiped") then
		local w = WeaponInfoFolder:FindFirstChild(char.WeaponEquiped.Value)
		if w then weapon = w end
	end

	local animFolder = weapon:FindFirstChild("FanAnimations")
	if animFolder then
		local anim = animFolder:FindFirstChild("P_".._G.Clicked)
		if anim then hum:LoadAnimation(anim):Play() end
	end

	CombatEvent:FireServer(
		_G.Clicked,
		weapon,
		root.CFrame,
		true,
		weapon
	)

	_G.Clicked += 1
	if _G.Clicked > 4 then _G.Clicked = 1 end

	task.delay(0.4,function()
		Attacking = false
		UsingAttack = false
		_G.GCD = false
	end)
end

ResetComboEvent.OnClientEvent:Connect(function()
	_G.Clicked = 1
end)

-- ===== KILL AURA (100% FIEL) =====
local KillAura = {
	Range = 12,
	Delay = 0.4,
	LastHit = 0
}

local function getNearestNPC()
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local nearest, dist = nil, KillAura.Range

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChild("Humanoid")
			local r = npc:FindFirstChild("HumanoidRootPart")
			if hum and r and hum.Health > 0 then
				local d = (root.Position - r.Position).Magnitude
				if d <= dist then
					dist = d
					nearest = npc
				end
			end
		end
	end

	return nearest
end

RunService.Heartbeat:Connect(function()
	if not state.killAuraEnabled then return end
	if tick() - KillAura.LastHit < KillAura.Delay then return end
	if not getNearestNPC() then return end

	KillAura.LastHit = tick()
	DoAttack()
end)

-- ===== AUTOFARM =====
RunService.Heartbeat:Connect(function()
	if not state.autofarmEnabled then return end

	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local npc = getNearestNPC()
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	root.CFrame =
		npcRoot.CFrame
		- npcRoot.CFrame.LookVector * 3.5
		+ Vector3.new(0, 2.5, 0)
end)

-- ===== SPEED =====
RunService.Heartbeat:Connect(function()
	if not state.speedEnabled then return end
	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if hum and root and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity =
			hum.MoveDirection.Unit * state.speedValue +
			Vector3.new(0, root.AssemblyLinearVelocity.Y, 0)
	end
end)

-- ===== INFINITE JUMP =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- ===== BUTTONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ğŸ¤– Autofarm: ON" or "ğŸ¤– Autofarm: OFF"
end)

auraBtn.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	auraBtn.Text = state.killAuraEnabled and "ğŸ—¡ï¸ Kill Aura: ON" or "ğŸ—¡ï¸ Kill Aura: OFF"
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "ğŸš€ Infinite Jump: ON" or "ğŸš€ Infinite Jump: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled
	state.speedValue = tonumber(speedBox.Text) or state.speedValue
	speedBtn.Text = state.speedEnabled and "ğŸ’¨ Speed: ON" or "ğŸ’¨ Speed: OFF"
end)

-- ===== INPUT (F1) =====
UserInputService.InputBegan:Connect(function(input)
	if input.KeyCode == state.guiToggleKey then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)
