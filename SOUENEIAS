-- ===== AUTOFARM ULTRA-LEVE COM ANTI-KNOCKBACK, INFINITE JUMP E VELOCITY SPEED =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONSTANTES =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	UPDATE_INTERVAL = 1,
	GUI_NAME = "InfoExperienciaGui",
	NPC_SCAN_INTERVAL = 0.3
}

local COLORS = {
	BACKGROUND = Color3.fromRGB(25, 25, 30),
	HEADER = Color3.fromRGB(35, 35, 45),
	CLOSE_BTN = Color3.fromRGB(231, 76, 60),
	MINIMIZE_BTN = Color3.fromRGB(241, 196, 15),
	BTN_OFF = Color3.fromRGB(52, 73, 94),
	BTN_ON = Color3.fromRGB(46, 204, 113),
	TEXT = Color3.fromRGB(236, 240, 241),
	TEXT_SECONDARY = Color3.fromRGB(149, 165, 166),
	INPUT_BG = Color3.fromRGB(44, 62, 80),
	ACCENT = Color3.fromRGB(52, 152, 219)
}

-- ===== CACHE =====
local workspace = workspace
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new

-- >>> PASTA DOS NPCs (OTIMIZAÃ‡ÃƒO PRINCIPAL)
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	speedValue = 50,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	connections = {},
	guiVisible = true
}

-- ===== UTILITY FUNCTIONS =====
local function cleanupOldGui()
	local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
	if oldGui then
		oldGui:Destroy()
	end
end

local function createUICorner(radius, parent)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius)
	corner.Parent = parent
	return corner
end

local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

local function createButton(parent, size, position, text, color)
	local btn = Instance.new("TextButton")
	btn.Parent = parent
	btn.Size = size
	btn.Position = position
	btn.BackgroundColor3 = color
	btn.TextColor3 = COLORS.TEXT
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 16
	btn.Text = text
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	createUICorner(8, btn)

	btn.MouseEnter:Connect(function()
		btn.BackgroundColor3 = color:Lerp(Color3.new(1,1,1), 0.08)
	end)

	btn.MouseLeave:Connect(function()
		btn.BackgroundColor3 = color
	end)

	return btn
end

-- ===== GUI CREATION =====
cleanupOldGui()

local screenGui = Instance.new("ScreenGui")
screenGui.Name = CONFIG.GUI_NAME
screenGui.ResetOnSpawn = false
screenGui.Parent = CoreGui

local frame = Instance.new("Frame")
frame.Parent = screenGui
frame.Size = UDim2_new(0, 680, 0, 280)
frame.Position = UDim2_new(0.5, -340, 0.5, -140)
frame.BackgroundColor3 = COLORS.BACKGROUND
frame.BorderSizePixel = 0
frame.Active = true
createUICorner(16, frame)

-- Header
local header = Instance.new("Frame")
header.Parent = frame
header.Size = UDim2_new(1, 0, 0, 50)
header.BackgroundColor3 = COLORS.HEADER
header.BorderSizePixel = 0
createUICorner(16, header)

local titleLabel = Instance.new("TextLabel")
titleLabel.Parent = header
titleLabel.Size = UDim2_new(1, -120, 1, 0)
titleLabel.Position = UDim2_new(0, 20, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = COLORS.TEXT
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 20
titleLabel.Text = "ðŸŽ® AUTOFARM CONTROLLER"
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- ===== AUTOFARM (OTIMIZADO) =====

-- Atualiza cache de NPCs SOMENTE em workspace.Alive
local function updateNPCCache()
	table.clear(state.npcCache)

	local character = player.Character
	if not character then return end

	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local rootPos = root.Position

	for _, descendant in ipairs(AliveFolder:GetDescendants()) do
		if descendant:IsA("Model") and descendant ~= character then
			local humanoid = descendant:FindFirstChild("Humanoid")
			local npcRoot = descendant:FindFirstChild("HumanoidRootPart")

			if humanoid and npcRoot and humanoid.Health > 0
				and not Players:GetPlayerFromCharacter(descendant) then

				local distance = (rootPos - npcRoot.Position).Magnitude
				if distance <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {
						model = descendant,
						root = npcRoot,
						humanoid = humanoid,
						distance = distance
					})
				end
			end
		end
	end

	table.sort(state.npcCache, function(a, b)
		return a.distance < b.distance
	end)
end

local function findClosestNPC()
	local now = tick()
	if now - state.lastNPCScan >= CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = now
	end

	for _, npc in ipairs(state.npcCache) do
		if npc.model and npc.model.Parent and npc.humanoid.Health > 0 then
			return npc.model
		end
	end
	return nil
end

local function isNPCValid(npc)
	if not npc or not npc.Parent then return false end

	local humanoid = npc:FindFirstChild("Humanoid")
	if not humanoid or humanoid.Health <= 0 then return false end

	local character = player.Character
	if not character then return false end

	local root = character:FindFirstChild("HumanoidRootPart")
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not root or not npcRoot then return false end

	return (root.Position - npcRoot.Position).Magnitude <= CONFIG.MAX_DISTANCE
end

local function autofarmLoop()
	if not state.autofarmEnabled then return end

	local character = player.Character
	if not character then return end

	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return end

	if not isNPCValid(state.lockedNPC) then
		state.lockedNPC = findClosestNPC()
	end

	local npc = state.lockedNPC
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then
		state.lockedNPC = nil
		return
	end

	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero

	local targetCFrame =
		npcRoot.CFrame
		* CFrame_new(0, CONFIG.HEIGHT_OFFSET, CONFIG.BACK_DISTANCE)

	root.CFrame = targetCFrame
end

RunService.Heartbeat:Connect(autofarmLoop)

print("âœ… AUTOFARM CARREGADO COM SUCESSO | NPCs buscados apenas em workspace.Alive")
