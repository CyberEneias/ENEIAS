-- ===== FFRE GUI V3 - ULTIMATE EDITION =====
-- Design NS HUB Style + Visual Features + Safe Teleport
-- Desktop Config Save + ESP + Tracers + Health Bars

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	NPC_SCAN_INTERVAL = 0.3,
	M1_CLICK_DELAY = 0.15,
	CHAR_CACHE_UPDATE = 0.5,
	GUI_NAME = "FFREStyledGui",
	CONFIGS_FOLDER = nil, -- Will be set to desktop
	DEFAULT_CONFIG_NAME = "Default",
	TELEPORT_TWEEN_TIME = 0.5 -- Smooth teleport to avoid kick
}

-- ===== GET DESKTOP PATH =====
local function getDesktopPath()
	local desktopPath = nil
	
	pcall(function()
		if os.getenv then
			local userProfile = os.getenv("USERPROFILE")
			if userProfile then
				desktopPath = userProfile .. "\\Desktop\\"
			end
		end
	end)
	
	if not desktopPath then
		desktopPath = "C:\\Users\\" .. (os.getenv and os.getenv("USERNAME") or "User") .. "\\Desktop\\"
	end
	
	return desktopPath .. "FFRE_Configs\\"
end

CONFIG.CONFIGS_FOLDER = getDesktopPath()

-- ===== NPC FOLDER =====
local LiveNPCs = workspace:WaitForChild("LiveNPCS")

-- ===== CACHE =====
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new
local Color3_fromRGB = Color3.fromRGB
local Color3_white = Color3.new(1,1,1)

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	m1MacroEnabled = false,
	espEnabled = false,
	tracersEnabled = false,
	healthBarsEnabled = false,
	speedValue = 160,
	m1ClickDelay = CONFIG.M1_CLICK_DELAY,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	lastM1Click = 0,
	connections = {},
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	charCache = {
		root = nil,
		humanoid = nil,
		character = nil,
		lastUpdate = 0
	},
	lastSpeedApply = 0,
	currentPage = "combat",
	selectedConfig = nil,
	autoLoadConfig = nil,
	espObjects = {},
	tracerLines = {},
	healthBarObjects = {},
	isTeleporting = false
}

-- ===== CONFIGURATION SYSTEM =====
local ConfigSystem = {}

function ConfigSystem.ensureFolder()
	if not isfolder or not makefolder then 
		warn("[CONFIG] File system not available")
		return false 
	end
	
	local success = pcall(function()
		if not isfolder(CONFIG.CONFIGS_FOLDER) then
			makefolder(CONFIG.CONFIGS_FOLDER)
			print("[CONFIG] Created folder: " .. CONFIG.CONFIGS_FOLDER)
		end
	end)
	
	return success
end

function ConfigSystem.getConfigList()
	if not ConfigSystem.ensureFolder() then return {} end
	if not listfiles then return {} end
	
	local configs = {}
	local success, files = pcall(function()
		return listfiles(CONFIG.CONFIGS_FOLDER)
	end)
	
	if not success then return {} end
	
	for _, file in ipairs(files) do
		local name = file:match("([^/\\]+)%.json$")
		if name then
			table.insert(configs, name)
		end
	end
	
	table.sort(configs)
	return configs
end

function ConfigSystem.saveConfig(name, settings)
	if not ConfigSystem.ensureFolder() then 
		return false, "File system not available" 
	end
	
	if not writefile then
		return false, "writefile not available"
	end
	
	local success, err = pcall(function()
		local fullPath = CONFIG.CONFIGS_FOLDER .. name .. ".json"
		local data = HttpService:JSONEncode(settings)
		writefile(fullPath, data)
		print("[CONFIG] Saved: " .. fullPath)
	end)
	
	return success, err
end

function ConfigSystem.loadConfig(name)
	if not ConfigSystem.ensureFolder() then return nil end
	if not readfile or not isfile then return nil end
	
	local fullPath = CONFIG.CONFIGS_FOLDER .. name .. ".json"
	
	local fileExists = false
	pcall(function()
		fileExists = isfile(fullPath)
	end)
	
	if not fileExists then return nil end
	
	local success, data = pcall(function()
		local content = readfile(fullPath)
		return HttpService:JSONDecode(content)
	end)
	
	if success then
		print("[CONFIG] Loaded: " .. fullPath)
	end
	
	return success and data or nil
end

function ConfigSystem.deleteConfig(name)
	if not ConfigSystem.ensureFolder() then return false end
	if not delfile or not isfile then return false end
	
	local fullPath = CONFIG.CONFIGS_FOLDER .. name .. ".json"
	
	local success = pcall(function()
		if isfile(fullPath) then
			delfile(fullPath)
			print("[CONFIG] Deleted: " .. fullPath)
			return true
		end
	end)
	
	return success
end

function ConfigSystem.getCurrentSettings()
	return {
		speedValue = state.speedValue,
		m1ClickDelay = state.m1ClickDelay,
		guiToggleKey = state.guiToggleKey.Name,
		autofarmEnabled = state.autofarmEnabled,
		speedEnabled = state.speedEnabled,
		infiniteJumpEnabled = state.infiniteJumpEnabled,
		m1MacroEnabled = state.m1MacroEnabled,
		espEnabled = state.espEnabled,
		tracersEnabled = state.tracersEnabled,
		healthBarsEnabled = state.healthBarsEnabled,
		timestamp = os.date("%Y-%m-%d %H:%M:%S")
	}
end

function ConfigSystem.applySettings(settings)
	if not settings then return end
	
	state.speedValue = settings.speedValue or state.speedValue
	state.m1ClickDelay = settings.m1ClickDelay or state.m1ClickDelay
	
	task.spawn(function()
		task.wait(0.5)
		if toggleUpdateFunctions then
			if toggleUpdateFunctions.autofarm then
				toggleUpdateFunctions.autofarm(settings.autofarmEnabled == true)
			end
			if toggleUpdateFunctions.speed then
				toggleUpdateFunctions.speed(settings.speedEnabled == true)
			end
			if toggleUpdateFunctions.infiniteJump then
				toggleUpdateFunctions.infiniteJump(settings.infiniteJumpEnabled == true)
			end
			if toggleUpdateFunctions.m1Macro then
				toggleUpdateFunctions.m1Macro(settings.m1MacroEnabled == true)
			end
			if toggleUpdateFunctions.esp then
				toggleUpdateFunctions.esp(settings.espEnabled == true)
			end
			if toggleUpdateFunctions.tracers then
				toggleUpdateFunctions.tracers(settings.tracersEnabled == true)
			end
			if toggleUpdateFunctions.healthBars then
				toggleUpdateFunctions.healthBars(settings.healthBarsEnabled == true)
			end
		end
	end)
	
	local keyCode = settings.guiToggleKey and Enum.KeyCode[settings.guiToggleKey]
	if keyCode then
		state.guiToggleKey = keyCode
	end
	
	return true
end

-- ===== UTILS =====
local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

local function cleanAllConnections()
	for name, conn in pairs(state.connections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	table.clear(state.connections)
end

local function getCharComponents()
	local now = tick()
	if now - state.charCache.lastUpdate > CONFIG.CHAR_CACHE_UPDATE then
		local char = player.Character
		state.charCache.character = char
		state.charCache.root = char and char:FindFirstChild("HumanoidRootPart")
		state.charCache.humanoid = char and char:FindFirstChildOfClass("Humanoid")
		state.charCache.lastUpdate = now
	end
	return state.charCache.root, state.charCache.humanoid, state.charCache.character
end

local function invalidateCharCache()
	state.charCache.lastUpdate = 0
end

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local root, _, _ = getCharComponents()
	if not root then return end

	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc ~= player.Character then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {model=npc, root=npcRoot, humanoid=hum, distance=dist})
				end
			end
		end
	end

	table.sort(state.npcCache, function(a,b) return a.distance < b.distance end)
end

local function findClosestNPC()
	local now = tick()
	if now - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = now
	end
	return state.npcCache[1] and state.npcCache[1].model
end

-- ===== ESP SYSTEM =====
local function createESP(npc)
	if state.espObjects[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end
	
	local highlight = Instance.new("Highlight")
	highlight.Name = "FFREHighlight"
	highlight.Adornee = npc
	highlight.FillColor = Color3_fromRGB(255, 0, 0)
	highlight.OutlineColor = Color3_fromRGB(255, 255, 255)
	highlight.FillTransparency = 0.5
	highlight.OutlineTransparency = 0
	highlight.Parent = npc
	
	state.espObjects[npc] = highlight
end

local function removeESP(npc)
	if state.espObjects[npc] then
		state.espObjects[npc]:Destroy()
		state.espObjects[npc] = nil
	end
end

local function clearAllESP()
	for npc, esp in pairs(state.espObjects) do
		if esp then esp:Destroy() end
	end
	table.clear(state.espObjects)
end

-- ===== TRACERS SYSTEM (FIXED) =====
local function createTracer(npc)
	if state.tracerLines[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end
	
	-- Create line using Drawing API (works better than Beams)
	local line = Drawing.new("Line")
	line.Visible = true
	line.Color = Color3.new(0, 1, 0) -- Green
	line.Thickness = 2
	line.Transparency = 0.7
	
	state.tracerLines[npc] = line
end

local function updateTracers()
	if not state.tracersEnabled then return end
	
	local camera = workspace.CurrentCamera
	local root = getCharComponents()
	
	for npc, line in pairs(state.tracerLines) do
		if npc and npc.Parent then
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if npcRoot then
				local npcPos, onScreen = camera:WorldToViewportPoint(npcRoot.Position)
				local screenSize = camera.ViewportSize
				
				if onScreen then
					line.From = Vector2.new(screenSize.X / 2, screenSize.Y)
					line.To = Vector2.new(npcPos.X, npcPos.Y)
					line.Visible = true
				else
					line.Visible = false
				end
			else
				line.Visible = false
			end
		else
			line.Visible = false
		end
	end
end

local function removeTracer(npc)
	if state.tracerLines[npc] then
		state.tracerLines[npc]:Remove()
		state.tracerLines[npc] = nil
	end
end

local function clearAllTracers()
	for npc, line in pairs(state.tracerLines) do
		if line then line:Remove() end
	end
	table.clear(state.tracerLines)
end

-- ===== HEALTH BAR SYSTEM =====
local function createHealthBar(npc)
	if state.healthBarObjects[npc] then return end
	
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	local npcHum = npc:FindFirstChild("Humanoid")
	if not npcRoot or not npcHum then return end
	
	local billboardGui = Instance.new("BillboardGui")
	billboardGui.Name = "FFREHealthBar"
	billboardGui.Adornee = npcRoot
	billboardGui.Size = UDim2_new(4, 0, 0.5, 0)
	billboardGui.StudsOffset = Vector3_new(0, 3, 0)
	billboardGui.AlwaysOnTop = true
	billboardGui.Parent = npc
	
	local frame = Instance.new("Frame")
	frame.Size = UDim2_new(1, 0, 1, 0)
	frame.BackgroundColor3 = Color3_fromRGB(40, 40, 40)
	frame.BorderSizePixel = 0
	frame.Parent = billboardGui
	
	local healthBar = Instance.new("Frame")
	healthBar.Name = "HealthBar"
	healthBar.Size = UDim2_new(npcHum.Health / npcHum.MaxHealth, 0, 1, 0)
	healthBar.BackgroundColor3 = Color3_fromRGB(0, 255, 0)
	healthBar.BorderSizePixel = 0
	healthBar.Parent = frame
	
	local healthText = Instance.new("TextLabel")
	healthText.Name = "HealthText"
	healthText.Size = UDim2_new(1, 0, 1, 0)
	healthText.BackgroundTransparency = 1
	healthText.Text = math.floor(npcHum.Health) .. "/" .. math.floor(npcHum.MaxHealth)
	healthText.TextColor3 = Color3_white
	healthText.TextScaled = true
	healthText.Font = Enum.Font.GothamBold
	healthText.Parent = frame
	
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 4)
	corner.Parent = frame
	
	local corner2 = Instance.new("UICorner")
	corner2.CornerRadius = UDim.new(0, 4)
	corner2.Parent = healthBar
	
	state.healthBarObjects[npc] = billboardGui
end

local function updateHealthBar(npc)
	local healthBarGui = state.healthBarObjects[npc]
	if not healthBarGui then return end
	
	local npcHum = npc:FindFirstChild("Humanoid")
	if not npcHum then return end
	
	local healthBar = healthBarGui:FindFirstChild("Frame"):FindFirstChild("HealthBar")
	local healthText = healthBarGui:FindFirstChild("Frame"):FindFirstChild("HealthText")
	
	if healthBar and healthText then
		local healthPercent = npcHum.Health / npcHum.MaxHealth
		healthBar.Size = UDim2_new(healthPercent, 0, 1, 0)
		healthText.Text = math.floor(npcHum.Health) .. "/" .. math.floor(npcHum.MaxHealth)
		
		if healthPercent > 0.5 then
			healthBar.BackgroundColor3 = Color3_fromRGB(0, 255, 0)
		elseif healthPercent > 0.25 then
			healthBar.BackgroundColor3 = Color3_fromRGB(255, 255, 0)
		else
			healthBar.BackgroundColor3 = Color3_fromRGB(255, 0, 0)
		end
	end
end

local function removeHealthBar(npc)
	if state.healthBarObjects[npc] then
		state.healthBarObjects[npc]:Destroy()
		state.healthBarObjects[npc] = nil
	end
end

local function clearAllHealthBars()
	for npc, gui in pairs(state.healthBarObjects) do
		if gui then gui:Destroy() end
	end
	table.clear(state.healthBarObjects)
end

-- ===== VISUAL FEATURES UPDATE =====
local function updateVisuals()
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc ~= player.Character then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			
			if hum and npcRoot and hum.Health > 0 then
				if state.espEnabled then
					createESP(npc)
				else
					removeESP(npc)
				end
				
				if state.tracersEnabled then
					createTracer(npc)
				else
					removeTracer(npc)
				end
				
				if state.healthBarsEnabled then
					createHealthBar(npc)
					updateHealthBar(npc)
				else
					removeHealthBar(npc)
				end
			else
				removeESP(npc)
				removeTracer(npc)
				removeHealthBar(npc)
			end
		end
	end
	
	-- Update tracers positions
	updateTracers()
end

-- ===== SAFE TELEPORT SYSTEM (ANTI-KICK) =====
local function safeTeleportToNPC(npcName)
	if state.isTeleporting then
		return false, "Already teleporting..."
	end
	
	local root, _, _ = getCharComponents()
	if not root then return false, "Character not found" end
	
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc.Name == npcName and npc:IsA("Model") then
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if npcRoot then
				state.isTeleporting = true
				
				-- Calculate target position (5 studs in front)
				local targetCFrame = npcRoot.CFrame * CFrame_new(0, 0, 5)
				
				-- Smooth tween to avoid anticheat
				local tweenInfo = TweenInfo.new(
					CONFIG.TELEPORT_TWEEN_TIME,
					Enum.EasingStyle.Linear,
					Enum.EasingDirection.Out
				)
				
				local tween = TweenService:Create(root, tweenInfo, {CFrame = targetCFrame})
				tween:Play()
				
				tween.Completed:Connect(function()
					state.isTeleporting = false
				end)
				
				return true, "Teleporting..."
			end
		end
	end
	
	return false, "NPC not found"
end

local function getNPCList()
	local npcList = {}
	for _, npc in ipairs(LiveNPCs:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
			if not table.find(npcList, npc.Name) then
				table.insert(npcList, npc.Name)
			end
		end
	end
	table.sort(npcList)
	return npcList
end

-- ===== M1 MACRO =====
local function simulateMouseClick()
	local virtualInput = game:GetService("VirtualInputManager")
	virtualInput:SendMouseButtonEvent(0, 0, 0, true, game, 0)
	task.wait(0.01)
	virtualInput:SendMouseButtonEvent(0, 0, 0, false, game, 0)
end

local function m1MacroLoop()
	if not state.m1MacroEnabled then return end
	local now = tick()
	if now - state.lastM1Click >= state.m1ClickDelay then
		pcall(simulateMouseClick)
		state.lastM1Click = now
	end
end

-- ===== AUTOFARM =====
local function isNPCValid(npc)
	if not npc or not npc.Parent then return false end
	local hum = npc:FindFirstChild("Humanoid")
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not hum or not npcRoot or hum.Health <= 0 then return false end
	
	local root, _, _ = getCharComponents()
	if not root then return false end
	
	local dist = (root.Position - npcRoot.Position).Magnitude
	return dist <= CONFIG.MAX_DISTANCE
end

local function autofarmLoop()
	if not state.autofarmEnabled then return end
	local root, _, _ = getCharComponents()
	if not root then return end

	if not isNPCValid(state.lockedNPC) then
		state.lockedNPC = findClosestNPC()
	end

	local npc = state.lockedNPC
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then
		state.lockedNPC = nil
		return
	end

	local npcCFrame = npcRoot.CFrame
	local backVector = -npcCFrame.LookVector * CONFIG.BACK_DISTANCE
	local upVector = Vector3_new(0, CONFIG.HEIGHT_OFFSET, 0)
	local targetCFrame = CFrame_new(npcRoot.Position + backVector + upVector)

	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero
	root.CFrame = targetCFrame
end

-- ===== SPEED BOOST =====
local function speedLoop()
	if not state.speedEnabled then return end
	local root, hum, _ = getCharComponents()
	if root and hum then
		local moveDir = hum.MoveDirection
		if moveDir.Magnitude > 0 then
			local currentY = root.AssemblyLinearVelocity.Y
			root.AssemblyLinearVelocity = (moveDir.Unit * state.speedValue) + Vector3_new(0, currentY, 0)
		end
	end
end

-- ===== CLEANUP OLD GUI =====
pcall(function()
	CoreGui:FindFirstChild(CONFIG.GUI_NAME):Destroy()
end)

-- ===== GUI CREATION (NS HUB STYLE) =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = CONFIG.GUI_NAME
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = CoreGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2_new(0, 550, 0, 400)
mainFrame.Position = UDim2_new(0.5, -275, 0.5, -200)
mainFrame.BackgroundColor3 = Color3_fromRGB(15, 15, 22)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 10)
mainCorner.Parent = mainFrame

-- Header Bar
local headerBar = Instance.new("Frame")
headerBar.Name = "HeaderBar"
headerBar.Size = UDim2_new(1, 0, 0, 40)
headerBar.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
headerBar.BorderSizePixel = 0
headerBar.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 10)
headerCorner.Parent = headerBar

local headerFill = Instance.new("Frame")
headerFill.Size = UDim2_new(1, 0, 0, 10)
headerFill.Position = UDim2_new(0, 0, 1, -10)
headerFill.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
headerFill.BorderSizePixel = 0
headerFill.Parent = headerBar

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2_new(1, -100, 1, 0)
titleLabel.Position = UDim2_new(0, 15, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "FFRE GUI V3"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 16
titleLabel.TextColor3 = Color3_white
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = headerBar

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2_new(0, 30, 0, 30)
closeBtn.Position = UDim2_new(1, -35, 0, 5)
closeBtn.BackgroundColor3 = Color3_fromRGB(200, 50, 50)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 16
closeBtn.TextColor3 = Color3_white
closeBtn.BorderSizePixel = 0
closeBtn.Parent = headerBar

local closeBtnCorner = Instance.new("UICorner")
closeBtnCorner.CornerRadius = UDim.new(0, 6)
closeBtnCorner.Parent = closeBtn

closeBtn.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

-- Tab Buttons Container
local tabsContainer = Instance.new("Frame")
tabsContainer.Size = UDim2_new(1, -20, 0, 35)
tabsContainer.Position = UDim2_new(0, 10, 0, 50)
tabsContainer.BackgroundTransparency = 1
tabsContainer.Parent = mainFrame

local tabsLayout = Instance.new("UIListLayout")
tabsLayout.FillDirection = Enum.FillDirection.Horizontal
tabsLayout.Padding = UDim.new(0, 8)
tabsLayout.Parent = tabsContainer

-- Helper: Create Tab
local function createTab(name, text)
	local tab = Instance.new("TextButton")
	tab.Name = name
	tab.Size = UDim2_new(0, 125, 0, 35)
	tab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	tab.Text = text
	tab.Font = Enum.Font.GothamBold
	tab.TextSize = 13
	tab.TextColor3 = Color3_fromRGB(180, 180, 190)
	tab.BorderSizePixel = 0
	tab.AutoButtonColor = false
	tab.Parent = tabsContainer
	
	local tabCorner = Instance.new("UICorner")
	tabCorner.CornerRadius = UDim.new(0, 8)
	tabCorner.Parent = tab
	
	return tab
end

local combatTab = createTab("CombatTab", "âš”ï¸ Combat")
local visualTab = createTab("VisualTab", "ğŸ‘ï¸ Visual")
local teleportTab = createTab("TeleportTab", "ğŸ“ Teleport")
local configsTab = createTab("ConfigsTab", "âš™ï¸ Configs")

-- Content Container
local contentContainer = Instance.new("Frame")
contentContainer.Size = UDim2_new(1, -20, 1, -100)
contentContainer.Position = UDim2_new(0, 10, 0, 90)
contentContainer.BackgroundTransparency = 1
contentContainer.Parent = mainFrame

-- Create Pages
local function createPage(name)
	local page = Instance.new("ScrollingFrame")
	page.Name = name
	page.Size = UDim2_new(1, 0, 1, 0)
	page.BackgroundTransparency = 1
	page.BorderSizePixel = 0
	page.ScrollBarThickness = 4
	page.ScrollBarImageColor3 = Color3_fromRGB(80, 80, 120)
	page.CanvasSize = UDim2_new(0, 0, 0, 0)
	page.AutomaticCanvasSize = Enum.AutomaticSize.Y
	page.Visible = false
	page.Parent = contentContainer
	
	local pageLayout = Instance.new("UIListLayout")
	pageLayout.Padding = UDim.new(0, 10)
	pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
	pageLayout.Parent = page
	
	return page
end

local scrollFrame = createPage("CombatPage")
local visualPage = createPage("VisualPage")
local teleportPage = createPage("TeleportPage")
local configsContainer = createPage("ConfigsPage")

-- Tab Switching
local function switchPage(page, tab)
	scrollFrame.Visible = false
	visualPage.Visible = false
	teleportPage.Visible = false
	configsContainer.Visible = false
	
	combatTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	combatTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	visualTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	visualTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	teleportTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	teleportTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	configsTab.BackgroundColor3 = Color3_fromRGB(25, 25, 35)
	configsTab.TextColor3 = Color3_fromRGB(180, 180, 190)
	
	page.Visible = true
	tab.BackgroundColor3 = Color3_fromRGB(80, 120, 200)
	tab.TextColor3 = Color3_white
end

combatTab.MouseButton1Click:Connect(function()
	switchPage(scrollFrame, combatTab)
	state.currentPage = "combat"
end)

visualTab.MouseButton1Click:Connect(function()
	switchPage(visualPage, visualTab)
	state.currentPage = "visual"
end)

teleportTab.MouseButton1Click:Connect(function()
	switchPage(teleportPage, teleportTab)
	state.currentPage = "teleport"
end)

configsTab.MouseButton1Click:Connect(function()
	switchPage(configsContainer, configsTab)
	state.currentPage = "configs"
end)

-- Initialize
switchPage(scrollFrame, combatTab)

-- Helper: Create Toggle
local function createToggle(parent, labelText, defaultState)
	local container = Instance.new("Frame")
	container.Size = UDim2_new(1, -5, 0, 40)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	container.Parent = parent
	
	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 8)
	containerCorner.Parent = container
	
	local label = Instance.new("TextLabel")
	label.Size = UDim2_new(0.65, 0, 1, 0)
	label.Position = UDim2_new(0, 12, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = labelText
	label.Font = Enum.Font.Gotham
	label.TextSize = 13
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = container
	
	local toggle = Instance.new("TextButton")
	toggle.Size = UDim2_new(0, 70, 0, 28)
	toggle.Position = UDim2_new(1, -80, 0.5, -14)
	toggle.BackgroundColor3 = defaultState and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	toggle.Text = defaultState and "ON" or "OFF"
	toggle.Font = Enum.Font.GothamBold
	toggle.TextSize = 12
	toggle.TextColor3 = Color3_white
	toggle.BorderSizePixel = 0
	toggle.AutoButtonColor = false
	toggle.Parent = container
	
	local toggleCorner = Instance.new("UICorner")
	toggleCorner.CornerRadius = UDim.new(0, 6)
	toggleCorner.Parent = toggle
	
	return container, toggle
end

-- Helper: Create Input
local function createInputField(parent, labelText, placeholder, defaultValue)
	local container = Instance.new("Frame")
	container.Size = UDim2_new(1, -5, 0, 65)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	container.Parent = parent
	
	local containerCorner = Instance.new("UICorner")
	containerCorner.CornerRadius = UDim.new(0, 8)
	containerCorner.Parent = container
	
	local label = Instance.new("TextLabel")
	label.Size = UDim2_new(1, -20, 0, 22)
	label.Position = UDim2_new(0, 12, 0, 8)
	label.BackgroundTransparency = 1
	label.Text = labelText
	label.Font = Enum.Font.GothamBold
	label.TextSize = 13
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = container
	
	local input = Instance.new("TextBox")
	input.Size = UDim2_new(1, -24, 0, 28)
	input.Position = UDim2_new(0, 12, 0, 32)
	input.BackgroundColor3 = Color3_fromRGB(30, 30, 40)
	input.PlaceholderText = placeholder
	input.Text = defaultValue or ""
	input.Font = Enum.Font.Gotham
	input.TextSize = 12
	input.TextColor3 = Color3_white
	input.BorderSizePixel = 0
	input.ClearTextOnFocus = false
	input.Parent = container
	
	local inputCorner = Instance.new("UICorner")
	inputCorner.CornerRadius = UDim.new(0, 6)
	inputCorner.Parent = input
	
	return container, input
end

-- Helper: Create Button
local function createConfigButton(parent, text, color)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2_new(1, -5, 0, 40)
	btn.BackgroundColor3 = color
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 13
	btn.TextColor3 = Color3_white
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	btn.Parent = parent
	
	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(0, 8)
	btnCorner.Parent = btn
	
	return btn
end

-- ===== COMBAT PAGE =====
local autofarmContainer, autofarmToggle = createToggle(scrollFrame, "ğŸ¤– Auto Farm", state.autofarmEnabled)
local speedContainer, speedToggle = createToggle(scrollFrame, "âš¡ Speed Boost", state.speedEnabled)
local speedInputContainer, speedInput = createInputField(scrollFrame, "Speed Value", "160", tostring(state.speedValue))
local jumpContainer, jumpToggle = createToggle(scrollFrame, "ğŸš€ Infinite Jump", state.infiniteJumpEnabled)
local m1Container, m1Toggle = createToggle(scrollFrame, "ğŸ–±ï¸ M1 Macro (F2)", state.m1MacroEnabled)
local m1InputContainer, m1Input = createInputField(scrollFrame, "M1 Click Delay", "0.15", tostring(state.m1ClickDelay))

-- ===== VISUAL PAGE =====
local espContainer, espToggle = createToggle(visualPage, "ğŸ‘ï¸ ESP (Highlight NPCs)", state.espEnabled)
local tracersContainer, tracersToggle = createToggle(visualPage, "ğŸ“ Tracers (Lines to NPCs)", state.tracersEnabled)
local healthBarsContainer, healthBarsToggle = createToggle(visualPage, "â¤ï¸ Health Bars", state.healthBarsEnabled)

-- ===== TELEPORT PAGE =====
local tpInfoFrame = Instance.new("Frame")
tpInfoFrame.Size = UDim2_new(1, -5, 0, 55)
tpInfoFrame.BackgroundColor3 = Color3_fromRGB(80, 120, 200)
tpInfoFrame.BorderSizePixel = 0
tpInfoFrame.Parent = teleportPage

local tpInfoCorner = Instance.new("UICorner")
tpInfoCorner.CornerRadius = UDim.new(0, 8)
tpInfoCorner.Parent = tpInfoFrame

local tpInfoLabel = Instance.new("TextLabel")
tpInfoLabel.Size = UDim2_new(1, -20, 1, 0)
tpInfoLabel.Position = UDim2_new(0, 10, 0, 0)
tpInfoLabel.BackgroundTransparency = 1
tpInfoLabel.Text = "ğŸ“ Safe Teleport System\nClick any NPC to teleport (anti-kick protection)"
tpInfoLabel.Font = Enum.Font.GothamBold
tpInfoLabel.TextSize = 13
tpInfoLabel.TextColor3 = Color3_white
tpInfoLabel.TextXAlignment = Enum.TextXAlignment.Left
tpInfoLabel.TextWrapped = true
tpInfoLabel.Parent = tpInfoFrame

local refreshNPCBtn = createConfigButton(teleportPage, "ğŸ”„ Refresh NPC List", Color3_fromRGB(80, 200, 120))

local npcListContainer = Instance.new("Frame")
npcListContainer.Name = "NPCListContainer"
npcListContainer.Size = UDim2_new(1, -5, 0, 0)
npcListContainer.AutomaticSize = Enum.AutomaticSize.Y
npcListContainer.BackgroundTransparency = 1
npcListContainer.Parent = teleportPage

local npcListLayout = Instance.new("UIListLayout")
npcListLayout.Padding = UDim.new(0, 5)
npcListLayout.SortOrder = Enum.SortOrder.LayoutOrder
npcListLayout.Parent = npcListContainer

local function populateNPCList()
	for _, child in ipairs(npcListContainer:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end
	
	local npcList = getNPCList()
	
	for _, npcName in ipairs(npcList) do
		local npcBtn = Instance.new("TextButton")
		npcBtn.Size = UDim2_new(1, 0, 0, 35)
		npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
		npcBtn.Text = "ğŸ“Œ " .. npcName
		npcBtn.Font = Enum.Font.Gotham
		npcBtn.TextSize = 12
		npcBtn.TextColor3 = Color3_white
		npcBtn.TextXAlignment = Enum.TextXAlignment.Left
		npcBtn.BorderSizePixel = 0
		npcBtn.AutoButtonColor = false
		npcBtn.Parent = npcListContainer
		
		local npcBtnPadding = Instance.new("UIPadding")
		npcBtnPadding.PaddingLeft = UDim.new(0, 10)
		npcBtnPadding.Parent = npcBtn
		
		local npcBtnCorner = Instance.new("UICorner")
		npcBtnCorner.CornerRadius = UDim.new(0, 6)
		npcBtnCorner.Parent = npcBtn
		
		npcBtn.MouseButton1Click:Connect(function()
			local success, msg = safeTeleportToNPC(npcName)
			if success then
				npcBtn.BackgroundColor3 = Color3_fromRGB(80, 200, 120)
				task.wait(0.5)
				npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
			else
				npcBtn.BackgroundColor3 = Color3_fromRGB(200, 50, 50)
				task.wait(0.5)
				npcBtn.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
			end
		end)
	end
end

refreshNPCBtn.MouseButton1Click:Connect(populateNPCList)

task.spawn(function()
	task.wait(1)
	populateNPCList()
end)

-- ===== CONFIGS PAGE =====

local configPathInfo = Instance.new("Frame")
configPathInfo.Size = UDim2_new(1, -5, 0, 70)
configPathInfo.BackgroundColor3 = Color3_fromRGB(80, 120, 200)
configPathInfo.BorderSizePixel = 0
configPathInfo.Parent = configsContainer

local configPathCorner = Instance.new("UICorner")
configPathCorner.CornerRadius = UDim.new(0, 8)
configPathCorner.Parent = configPathInfo

local configPathTitle = Instance.new("TextLabel")
configPathTitle.Size = UDim2_new(1, -20, 0, 20)
configPathTitle.Position = UDim2_new(0, 10, 0, 5)
configPathTitle.BackgroundTransparency = 1
configPathTitle.Text = "ğŸ’¾ Save Location:"
configPathTitle.Font = Enum.Font.GothamBold
configPathTitle.TextSize = 13
configPathTitle.TextColor3 = Color3_white
configPathTitle.TextXAlignment = Enum.TextXAlignment.Left
configPathTitle.Parent = configPathInfo

local configPathLabel = Instance.new("TextLabel")
configPathLabel.Size = UDim2_new(1, -20, 0, 40)
configPathLabel.Position = UDim2_new(0, 10, 0, 25)
configPathLabel.BackgroundTransparency = 1
configPathLabel.Text = CONFIG.CONFIGS_FOLDER
configPathLabel.Font = Enum.Font.Gotham
configPathLabel.TextSize = 10
configPathLabel.TextColor3 = Color3_fromRGB(230, 230, 240)
configPathLabel.TextXAlignment = Enum.TextXAlignment.Left
configPathLabel.TextWrapped = true
configPathLabel.Parent = configPathInfo

local configNameContainer, configNameBox = createInputField(configsContainer, "Config Name", "Enter name...")

local messageLabel = Instance.new("TextLabel")
messageLabel.Name = "MessageLabel"
messageLabel.Size = UDim2_new(1, -5, 0, 0)
messageLabel.BackgroundTransparency = 1
messageLabel.Text = ""
messageLabel.Font = Enum.Font.GothamBold
messageLabel.TextSize = 12
messageLabel.TextColor3 = Color3_fromRGB(100, 255, 100)
messageLabel.TextXAlignment = Enum.TextXAlignment.Center
messageLabel.TextWrapped = true
messageLabel.Visible = false
messageLabel.Parent = configsContainer

local function showMessage(scroll, text, color)
	messageLabel.Text = text
	messageLabel.TextColor3 = color
	messageLabel.Visible = true
	messageLabel.Size = UDim2_new(1, -5, 0, 30)
	task.wait(3)
	messageLabel.Visible = false
	messageLabel.Size = UDim2_new(1, -5, 0, 0)
end

local createConfigBtn = createConfigButton(configsContainer, "â• Create Config", Color3_fromRGB(80, 120, 200))
local loadConfigBtn = createConfigButton(configsContainer, "ğŸ“‚ Load Config", Color3_fromRGB(120, 80, 200))
local overwriteConfigBtn = createConfigButton(configsContainer, "âœï¸ Overwrite Config", Color3_fromRGB(200, 120, 80))
local refreshListBtn = createConfigButton(configsContainer, "ğŸ”„ Refresh List", Color3_fromRGB(80, 200, 120))

local configListTitle = Instance.new("TextLabel")
configListTitle.Size = UDim2_new(1, -5, 0, 25)
configListTitle.BackgroundTransparency = 1
configListTitle.Text = "ğŸ“‹ Saved Configurations:"
configListTitle.Font = Enum.Font.GothamBold
configListTitle.TextSize = 13
configListTitle.TextColor3 = Color3_white
configListTitle.TextXAlignment = Enum.TextXAlignment.Left
configListTitle.Parent = configsContainer

local configListContainer = Instance.new("Frame")
configListContainer.Name = "ConfigListContainer"
configListContainer.Size = UDim2_new(1, -5, 0, 0)
configListContainer.AutomaticSize = Enum.AutomaticSize.Y
configListContainer.BackgroundTransparency = 1
configListContainer.Parent = configsContainer

local configListLayout = Instance.new("UIListLayout")
configListLayout.Padding = UDim.new(0, 5)
configListLayout.SortOrder = Enum.SortOrder.LayoutOrder
configListLayout.Parent = configListContainer

local function updateConfigList(scroll)
	for _, child in ipairs(configListContainer:GetChildren()) do
		if child:IsA("Frame") and child.Name ~= "UIListLayout" then
			child:Destroy()
		end
	end
	
	local configs = ConfigSystem.getConfigList()
	
	for _, configName in ipairs(configs) do
		local configItem = Instance.new("Frame")
		configItem.Size = UDim2_new(1, 0, 0, 35)
		configItem.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
		configItem.BorderSizePixel = 0
		configItem.Parent = configListContainer
		
		local configItemCorner = Instance.new("UICorner")
		configItemCorner.CornerRadius = UDim.new(0, 6)
		configItemCorner.Parent = configItem
		
		local configItemBtn = Instance.new("TextButton")
		configItemBtn.Size = UDim2_new(0.7, 0, 1, 0)
		configItemBtn.Position = UDim2_new(0, 10, 0, 0)
		configItemBtn.BackgroundTransparency = 1
		configItemBtn.Text = "ğŸ“„ " .. configName
		configItemBtn.Font = Enum.Font.Gotham
		configItemBtn.TextSize = 12
		configItemBtn.TextColor3 = Color3_white
		configItemBtn.TextXAlignment = Enum.TextXAlignment.Left
		configItemBtn.AutoButtonColor = false
		configItemBtn.Parent = configItem
		
		local deleteBtn = Instance.new("TextButton")
		deleteBtn.Size = UDim2_new(0, 60, 0, 25)
		deleteBtn.Position = UDim2_new(1, -70, 0.5, -12.5)
		deleteBtn.BackgroundColor3 = Color3_fromRGB(200, 50, 50)
		deleteBtn.Text = "ğŸ—‘ï¸"
		deleteBtn.Font = Enum.Font.GothamBold
		deleteBtn.TextSize = 16
		deleteBtn.TextColor3 = Color3_white
		deleteBtn.BorderSizePixel = 0
		deleteBtn.AutoButtonColor = false
		deleteBtn.Parent = configItem
		
		local deleteBtnCorner = Instance.new("UICorner")
		deleteBtnCorner.CornerRadius = UDim.new(0, 6)
		deleteBtnCorner.Parent = deleteBtn
		
		configItemBtn.MouseButton1Click:Connect(function()
			state.selectedConfig = configName
			configNameBox.Text = configName
			
			for _, item in ipairs(configListContainer:GetChildren()) do
				if item:IsA("Frame") then
					item.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
				end
			end
			configItem.BackgroundColor3 = Color3_fromRGB(80, 120, 200)
		end)
		
		deleteBtn.MouseButton1Click:Connect(function()
			if ConfigSystem.deleteConfig(configName) then
				showMessage(configsContainer, "âœ… Deleted: " .. configName, Color3_fromRGB(100, 255, 100))
				updateConfigList(configsContainer)
				if state.selectedConfig == configName then
					state.selectedConfig = nil
					configNameBox.Text = ""
				end
			else
				showMessage(configsContainer, "âŒ Failed to delete!", Color3_fromRGB(255, 100, 100))
			end
		end)
	end
end

createConfigBtn.MouseButton1Click:Connect(function()
	local configName = configNameBox.Text:gsub("%s+", " "):gsub("^%s*(.-)%s*$", "%1")
	
	if configName == "" then
		showMessage(configsContainer, "âš ï¸ Enter a name!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	if configName:match("[^%w%s%-_]") then
		showMessage(configsContainer, "âš ï¸ Invalid characters!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local success, err = ConfigSystem.saveConfig(configName, ConfigSystem.getCurrentSettings())
	
	if success then
		showMessage(configsContainer, "âœ… Saved: " .. configName, Color3_fromRGB(100, 255, 100))
		state.selectedConfig = configName
		updateConfigList(configsContainer)
		configNameBox.Text = ""
	else
		showMessage(configsContainer, "âŒ Failed: " .. tostring(err), Color3_fromRGB(255, 100, 100))
	end
end)

loadConfigBtn.MouseButton1Click:Connect(function()
	if not state.selectedConfig then
		showMessage(configsContainer, "âš ï¸ Select a config!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local settings = ConfigSystem.loadConfig(state.selectedConfig)
	
	if settings then
		ConfigSystem.applySettings(settings)
		showMessage(configsContainer, "âœ… Loaded: " .. state.selectedConfig, Color3_fromRGB(100, 255, 100))
	else
		showMessage(configsContainer, "âŒ Failed to load!", Color3_fromRGB(255, 100, 100))
	end
end)

overwriteConfigBtn.MouseButton1Click:Connect(function()
	if not state.selectedConfig then
		showMessage(configsContainer, "âš ï¸ Select a config!", Color3_fromRGB(255, 200, 100))
		return
	end
	
	local success, err = ConfigSystem.saveConfig(state.selectedConfig, ConfigSystem.getCurrentSettings())
	
	if success then
		showMessage(configsContainer, "âœ… Overwritten: " .. state.selectedConfig, Color3_fromRGB(100, 255, 100))
	else
		showMessage(configsContainer, "âŒ Failed: " .. tostring(err), Color3_fromRGB(255, 100, 100))
	end
end)

refreshListBtn.MouseButton1Click:Connect(function()
	updateConfigList(configsContainer)
	showMessage(configsContainer, "âœ… Refreshed!", Color3_fromRGB(100, 255, 100))
end)

task.spawn(function()
	task.wait(1)
	updateConfigList(configsContainer)
end)

-- ===== TOGGLE UPDATE FUNCTIONS =====
toggleUpdateFunctions = {}

toggleUpdateFunctions.autofarm = function(enabled)
	state.autofarmEnabled = enabled
	autofarmToggle.Text = enabled and "ON" or "OFF"
	autofarmToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if enabled then
		disconnectConnection("autofarm")
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	else
		disconnectConnection("autofarm")
		state.lockedNPC = nil
	end
end

autofarmToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.autofarm(not state.autofarmEnabled)
end)

toggleUpdateFunctions.speed = function(enabled)
	state.speedEnabled = enabled
	speedToggle.Text = enabled and "ON" or "OFF"
	speedToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if enabled then
		local value = tonumber(speedInput.Text)
		if value and value > 0 then
			state.speedValue = value
		end
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	else
		disconnectConnection("speed")
	end
end

speedToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.speed(not state.speedEnabled)
end)

speedInput.FocusLost:Connect(function()
	local value = tonumber(speedInput.Text)
	if value and value > 0 then
		state.speedValue = value
	end
end)

toggleUpdateFunctions.infiniteJump = function(enabled)
	state.infiniteJumpEnabled = enabled
	jumpToggle.Text = enabled and "ON" or "OFF"
	jumpToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
end

jumpToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.infiniteJump(not state.infiniteJumpEnabled)
end)

toggleUpdateFunctions.m1Macro = function(enabled)
	state.m1MacroEnabled = enabled
	m1Toggle.Text = enabled and "ON" or "OFF"
	m1Toggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if enabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	else
		disconnectConnection("m1macro")
	end
end

m1Toggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.m1Macro(not state.m1MacroEnabled)
end)

m1Input.FocusLost:Connect(function()
	local value = tonumber(m1Input.Text)
	if value and value > 0 then
		state.m1ClickDelay = value
	end
end)

toggleUpdateFunctions.esp = function(enabled)
	state.espEnabled = enabled
	espToggle.Text = enabled and "ON" or "OFF"
	espToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if not enabled then
		clearAllESP()
	end
end

espToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.esp(not state.espEnabled)
end)

toggleUpdateFunctions.tracers = function(enabled)
	state.tracersEnabled = enabled
	tracersToggle.Text = enabled and "ON" or "OFF"
	tracersToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if not enabled then
		clearAllTracers()
	end
end

tracersToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.tracers(not state.tracersEnabled)
end)

toggleUpdateFunctions.healthBars = function(enabled)
	state.healthBarsEnabled = enabled
	healthBarsToggle.Text = enabled and "ON" or "OFF"
	healthBarsToggle.BackgroundColor3 = enabled and Color3_fromRGB(80, 200, 120) or Color3_fromRGB(70, 70, 90)
	
	if not enabled then
		clearAllHealthBars()
	end
end

healthBarsToggle.MouseButton1Click:Connect(function()
	toggleUpdateFunctions.healthBars(not state.healthBarsEnabled)
end)

-- ===== VISUAL UPDATE LOOP =====
state.connections.visualUpdate = RunService.RenderStepped:Connect(updateVisuals)

-- ===== INPUT HANDLING =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local _, hum, _ = getCharComponents()
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end

	if input.KeyCode == Enum.KeyCode.F1 then
		state.guiVisible = not state.guiVisible
		mainFrame.Visible = state.guiVisible
	end

	if input.KeyCode == Enum.KeyCode.F2 then
		toggleUpdateFunctions.m1Macro(not state.m1MacroEnabled)
	end
end)

-- ===== CHARACTER EVENTS =====
player.CharacterAdded:Connect(function(char)
	invalidateCharCache()
	task.wait(0.3)
	
	if state.speedEnabled then
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
	if state.m1MacroEnabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	end
end)

-- ===== CLEANUP =====
screenGui.Destroying:Connect(function()
	cleanAllConnections()
	clearAllESP()
	clearAllTracers()
	clearAllHealthBars()
end)

-- ===== STARTUP MESSAGE =====
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  FFRE GUI V3 - ULTIMATE EDITION")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  âš”ï¸ Combat:")
print("    â€¢ Auto Farm")
print("    â€¢ Speed Boost")
print("    â€¢ Infinite Jump")
print("    â€¢ M1 Auto Click")
print("  ğŸ‘ï¸ Visual:")
print("    â€¢ ESP (Highlights)")
print("    â€¢ Tracers (Fixed)")
print("    â€¢ Health Bars")
print("  ğŸ“ Teleport:")
print("    â€¢ Safe TP (Anti-Kick)")
print("  âš™ï¸ Configs:")
print("    â€¢ Desktop Save: " .. CONFIG.CONFIGS_FOLDER)
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("  Keybinds:")
print("    F1 - Toggle GUI")
print("    F2 - Toggle M1 Macro")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
