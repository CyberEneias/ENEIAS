-- ===== AUTOFARM FINAL LIMPO =====

-- ServiÃ§os
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	UPDATE_INTERVAL = 1,
	GUI_NAME = "InfoExperienciaGui"
}

-- ===== CORES =====
local COLORS = {
	BACKGROUND = Color3.fromRGB(25,25,30),
	HEADER = Color3.fromRGB(35,35,45),
	BTN_OFF = Color3.fromRGB(52,73,94),
	BTN_ON = Color3.fromRGB(46,204,113),
	TEXT = Color3.fromRGB(236,240,241),
	ACCENT = Color3.fromRGB(52,152,219),
	INPUT_BG = Color3.fromRGB(44,62,80),
	TEXT_SECONDARY = Color3.fromRGB(149,165,166)
}

-- ===== STATE =====
local state = {
	autofarm = false,
	infiniteJump = false,
	speed = false,
	speedValue = 50,
	lockedNPC = nil
}

-- ===== GUI LIMPA =====
pcall(function()
	local old = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
	if old then old:Destroy() end
end)

local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 600, 0, 260)
frame.Position = UDim2.new(0.5, -300, 0.5, -130)
frame.BackgroundColor3 = COLORS.BACKGROUND
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "ðŸŽ® AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.TextColor3 = COLORS.TEXT

local statusLabel = Instance.new("TextLabel", frame)
statusLabel.Position = UDim2.new(0, 20, 0, 50)
statusLabel.Size = UDim2.new(1, -40, 0, 40)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "ðŸŽ¯ NPC: Nenhum"
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextSize = 16
statusLabel.TextColor3 = COLORS.ACCENT

-- BotÃµes
local function makeButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0, 180, 0, 40)
	b.Position = UDim2.new(0, 20, 0, y)
	b.Text = text
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.TextColor3 = COLORS.TEXT
	b.BackgroundColor3 = COLORS.BTN_OFF
	return b
end

local autofarmBtn = makeButton("ðŸ¤– Autofarm: OFF", 100)
local jumpBtn = makeButton("ðŸš€ Infinite Jump: OFF", 150)
local speedBtn = makeButton("ðŸ’¨ Speed: OFF", 200)

-- ===== NPC UTILS =====
local function getNPCFolder()
	return workspace:FindFirstChild("alive")
end

local function getRoot(model)
	return model:FindFirstChild("HumanoidRootPart")
		or model.PrimaryPart
		or model:FindFirstChild("Torso")
end

local function isNPCValid(npc)
	if not npc or not npc.Parent then return false end
	local hum = npc:FindFirstChild("Humanoid")
	if not hum or hum.Health <= 0 then return false end

	local root = getRoot(npc)
	local char = player.Character
	local myRoot = char and char:FindFirstChild("HumanoidRootPart")
	if not root or not myRoot then return false end

	return (myRoot.Position - root.Position).Magnitude <= CONFIG.MAX_DISTANCE
end

local function findNearestNPC()
	local folder = getNPCFolder()
	if not folder then return nil end

	local char = player.Character
	local myRoot = char and char:FindFirstChild("HumanoidRootPart")
	if not myRoot then return nil end

	local closest, dist = nil, CONFIG.MAX_DISTANCE

	for _, npc in ipairs(folder:GetChildren()) do
		if npc:IsA("Model") then
			local hum = npc:FindFirstChild("Humanoid")
			local root = getRoot(npc)
			if hum and root and hum.Health > 0 then
				local d = (myRoot.Position - root.Position).Magnitude
				if d < dist then
					dist = d
					closest = npc
				end
			end
		end
	end

	return closest
end

-- ===== AUTOFARM LOOP =====
task.spawn(function()
	while true do
		if state.autofarm then
			if not isNPCValid(state.lockedNPC) then
				state.lockedNPC = findNearestNPC()
			end

			local npc = state.lockedNPC
			local char = player.Character
			local root = char and char:FindFirstChild("HumanoidRootPart")

			if npc and root then
				local npcRoot = getRoot(npc)
				if npcRoot then
					local pos =
						npcRoot.Position
						- npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
						+ Vector3.new(0, CONFIG.HEIGHT_OFFSET, 0)

					root.AssemblyLinearVelocity = Vector3.zero
					root.CFrame = CFrame.new(pos)
					statusLabel.Text = "ðŸŽ¯ NPC: " .. npc.Name
				end
			else
				statusLabel.Text = "ðŸŽ¯ NPC: Procurando..."
			end
		end
		task.wait(0.1)
	end
end)

-- ===== BOTÃ•ES =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarm = not state.autofarm
	state.lockedNPC = nil
	autofarmBtn.Text = state.autofarm and "ðŸ¤– Autofarm: ON" or "ðŸ¤– Autofarm: OFF"
	autofarmBtn.BackgroundColor3 = state.autofarm and COLORS.BTN_ON or COLORS.BTN_OFF
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJump = not state.infiniteJump
	jumpBtn.Text = state.infiniteJump and "ðŸš€ Infinite Jump: ON" or "ðŸš€ Infinite Jump: OFF"
	jumpBtn.BackgroundColor3 = state.infiniteJump and COLORS.BTN_ON or COLORS.BTN_OFF
end)

UserInputService.JumpRequest:Connect(function()
	if state.infiniteJump then
		local hum = player.Character and player.Character:FindFirstChild("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speed = not state.speed
	speedBtn.Text = state.speed and "ðŸ’¨ Speed: ON" or "ðŸ’¨ Speed: OFF"
	speedBtn.BackgroundColor3 = state.speed and COLORS.BTN_ON or COLORS.BTN_OFF
end)

RunService.Heartbeat:Connect(function()
	if state.speed then
		local char = player.Character
		local root = char and char:FindFirstChild("HumanoidRootPart")
		local hum = char and char:FindFirstChild("Humanoid")
		if root and hum and hum.MoveDirection.Magnitude > 0 then
			root.AssemblyLinearVelocity =
				hum.MoveDirection.Unit * state.speedValue
				+ Vector3.new(0, root.AssemblyLinearVelocity.Y, 0)
		end
	end
end)

-- ===== TEXTO DA EXPERIÃŠNCIA =====
task.spawn(function()
	while gui.Parent do
		title.Text = "ðŸŽ® AUTOFARM CONTROLLER | " .. game.Name
		task.wait(CONFIG.UPDATE_INTERVAL)
	end
end)
