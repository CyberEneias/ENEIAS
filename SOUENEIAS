-- ===== SERVICES =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ===== PLAYER =====
local player = Players.LocalPlayer
if not player then return end

-- ===== REMOTES =====
local CombatEvent = ReplicatedStorage.Events.CombatEvent

-- ===== GLOBAL COMBO =====
_G.Clicked = 1
_G.GCD = false
_G.FistDisabled = false

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	NPC_SCAN_INTERVAL = 0.3,
	KILL_AURA_RANGE = 12,
	KILL_AURA_DELAY = 0.4,
	GUI_NAME = "InfoExperienciaGui"
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	killAuraEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	speedValue = 160,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	connections = {},
	lastKillAura = 0,
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	waitingForKey = false
}

-- ===== UTILS =====
local function disconnect(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

-- ===== CLEAN GUI =====
local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if oldGui then oldGui:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 580, 0, 440)
frame.Position = UDim2.new(0.5, -290, 0.5, -220)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.Active = false
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,45)
title.BackgroundTransparency = 1
title.Text = "üî• AUTOFARM CONTROLLER"
title.Font = Enum.Font.GothamBold
title.TextSize = 22
title.TextColor3 = Color3.new(1,1,1)

local function createButton(text, y, w)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0,w or 240,0,45)
	b.Position = UDim2.new(0,20,0,y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local autofarmBtn = createButton("ü§ñ Autofarm: OFF", 60)
local auraBtn     = createButton("üó°Ô∏è Kill Aura: OFF", 120)
local jumpBtn     = createButton("üöÄ Infinite Jump: OFF", 180)
local speedBtn    = createButton("üí® Speed: OFF", 240)

-- ===== SPEED TEXTBOX =====
local speedBox = Instance.new("TextBox", frame)
speedBox.Size = UDim2.new(0,100,0,35)
speedBox.Position = UDim2.new(1,-130,0,245)
speedBox.Text = tostring(state.speedValue)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.BackgroundColor3 = Color3.fromRGB(50,70,90)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.PlaceholderText = "Speed"
Instance.new("UICorner", speedBox).CornerRadius = UDim.new(0,6)

-- ===== GUI KEY BUTTON =====
local guiKeyBtn = createButton("GUI key ("..state.guiToggleKey.Name..")", 300, 260)

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChild("Humanoid")
			local r = npc:FindFirstChild("HumanoidRootPart")
			if hum and r and hum.Health > 0 then
				local dist = (root.Position - r.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache,{model=npc,root=r,distance=dist})
				end
			end
		end
	end
	table.sort(state.npcCache,function(a,b) return a.distance < b.distance end)
end

local function getClosestNPC()
	if tick() - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = tick()
	end
	return state.npcCache[1]
end

-- ===== M1 SYSTEM =====
local Attacking = false
local WeaponInfoFolder = script:WaitForChild("WeaponInfoFolder")

local function CanAttack()
	if _G.FistDisabled or Attacking or _G.GCD then return end
	local char = player.Character
	if not char then return end
	if char:FindFirstChildOfClass("Tool") then return end
	for _,v in ipairs({"Stun","Parried","Knocked","TempKnocked","Carried","UsingMove"}) do
		if char:FindFirstChild(v) then return end
	end
	return true
end

local function AttemptM1()
	if not CanAttack() then return end

	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not hum or not root then return end

	Attacking = true
	_G.GCD = true

	local weapon = WeaponInfoFolder:FindFirstChild("Fist")
	if char:FindFirstChild("WeaponEquiped") then
		local w = WeaponInfoFolder:FindFirstChild(char.WeaponEquiped.Value)
		if w then weapon = w end
	end

	local animFolder = weapon:FindFirstChild("FanAnimations")
	if animFolder then
		local anim = animFolder["P_".._G.Clicked]
		if anim then hum:LoadAnimation(anim):Play() end
	end

	CombatEvent:FireServer(_G.Clicked, weapon, root.CFrame, true, weapon)

	_G.Clicked += 1
	if _G.Clicked > 4 then _G.Clicked = 1 end

	task.delay(0.4,function()
		Attacking = false
		_G.GCD = false
	end)
end

-- ===== AUTOFARM =====
local function autofarmLoop()
	if not state.autofarmEnabled then return end
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local data = getClosestNPC()
	if not data then return end
	state.lockedNPC = data.model

	root.CFrame =
		data.root.Position
		- data.root.CFrame.LookVector * CONFIG.BACK_DISTANCE
		+ Vector3.new(0, CONFIG.HEIGHT_OFFSET, 0)
end

-- ===== KILL AURA =====
local function killAuraLoop()
	if not (state.killAuraEnabled and state.autofarmEnabled) then return end
	if tick() - state.lastKillAura < CONFIG.KILL_AURA_DELAY then return end

	local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	local npc = state.lockedNPC
	if not root or not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if npcRoot and (root.Position - npcRoot.Position).Magnitude <= CONFIG.KILL_AURA_RANGE then
		state.lastKillAura = tick()
		AttemptM1()
	end
end

-- ===== SPEED =====
local function speedLoop()
	if not state.speedEnabled then return end
	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if hum and root and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity =
			hum.MoveDirection.Unit * state.speedValue +
			Vector3.new(0, root.AssemblyLinearVelocity.Y, 0)
	end
end

-- ===== INFINITE JUMP =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- ===== BUTTONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ü§ñ Autofarm: ON" or "ü§ñ Autofarm: OFF"
	disconnect("autofarm")
	if state.autofarmEnabled then
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	end
end)

auraBtn.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	auraBtn.Text = state.killAuraEnabled and "üó°Ô∏è Kill Aura: ON" or "üó°Ô∏è Kill Aura: OFF"
	disconnect("aura")
	if state.killAuraEnabled then
		state.connections.aura = RunService.Heartbeat:Connect(killAuraLoop)
	end
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "üöÄ Infinite Jump: ON" or "üöÄ Infinite Jump: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled
	speedBtn.Text = state.speedEnabled and "üí® Speed: ON" or "üí® Speed: OFF"
	state.speedValue = tonumber(speedBox.Text) or state.speedValue
	disconnect("speed")
	if state.speedEnabled then
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
end)

guiKeyBtn.MouseButton1Click:Connect(function()
	state.waitingForKey = true
	guiKeyBtn.Text = "Press a key..."
end)

-- ===== INPUT =====
UserInputService.InputBegan:Connect(function(input,gp)
	if gp then return end

	if state.waitingForKey and input.UserInputType == Enum.UserInputType.Keyboard then
		state.guiToggleKey = input.KeyCode
		guiKeyBtn.Text = "GUI key ("..state.guiToggleKey.Name..")"
		state.waitingForKey = false
	end

	if input.KeyCode == state.guiToggleKey then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)
