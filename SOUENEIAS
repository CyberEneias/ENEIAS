-- ===== SERVICES =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ===== PLAYER =====
local player = Players.LocalPlayer
if not player then return end
local PlayerGui = player:WaitForChild("PlayerGui")

-- ===== REMOTES =====
local Events = ReplicatedStorage:WaitForChild("Events")
local CombatEvent = Events:WaitForChild("CombatEvent")
local ResetComboEvent = Events:WaitForChild("ResetComboEvent")

-- ===== GLOBAL COMBO =====
_G.Clicked = 1
_G.GCD = false
_G.FistDisabled = false

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	killAuraEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	speedValue = 160,
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	connections = {},
	lockedNPC = nil
}

-- ===== CLEAN GUI =====
local oldGui = PlayerGui:FindFirstChild("InfoExperienciaGui")
if oldGui then oldGui:Destroy() end

-- ===== GUI =====
local gui = Instance.new("ScreenGui")
gui.Name = "InfoExperienciaGui"
gui.ResetOnSpawn = false
gui.Parent = PlayerGui

local frame = Instance.new("Frame")
frame.Parent = gui
frame.Size = UDim2.new(0,580,0,440)
frame.Position = UDim2.new(0.5,-290,0.5,-220)
frame.BackgroundColor3 = Color3.fromRGB(35,35,40)
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local function createButton(text, y)
	local b = Instance.new("TextButton")
	b.Parent = frame
	b.Size = UDim2.new(0,240,0,45)
	b.Position = UDim2.new(0,20,0,y)
	b.BackgroundColor3 = Color3.fromRGB(60,80,100)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 15
	b.Text = text
	b.AutoButtonColor = true
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local autofarmBtn = createButton("ğŸ¤– Autofarm: OFF", 60)
local auraBtn     = createButton("ğŸ—¡ï¸ Kill Aura: OFF", 120)
local jumpBtn     = createButton("ğŸš€ Infinite Jump: OFF", 180)
local speedBtn    = createButton("ğŸ’¨ Speed: OFF", 240)

local speedBox = Instance.new("TextBox")
speedBox.Parent = frame
speedBox.Size = UDim2.new(0,100,0,35)
speedBox.Position = UDim2.new(1,-130,0,245)
speedBox.Text = tostring(state.speedValue)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 14
speedBox.BackgroundColor3 = Color3.fromRGB(50,70,90)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.ClearTextOnFocus = false
Instance.new("UICorner", speedBox).CornerRadius = UDim.new(0,6)

-- ===== WEAPON INFO =====
local WeaponInfoFolder = script:FindFirstChild("WeaponInfoFolder")
if not WeaponInfoFolder then
	warn("[GUI] WeaponInfoFolder NÃƒO encontrado â€” combate desativado")
end

-- ===== COMBAT SYSTEM =====
local Attacking = false

local function CanAttack()
	if _G.FistDisabled or Attacking or _G.GCD then return end
	local char = player.Character
	if not char then return end
	if char:FindFirstChildOfClass("Tool") then return end
	for _,v in ipairs({"Stun","Parried","Knocked","TempKnocked","Carried","UsingMove"}) do
		if char:FindFirstChild(v) then return end
	end
	return true
end

local function DoAttack()
	if not WeaponInfoFolder then return end
	if not CanAttack() then return end

	local char = player.Character
	local hum = char and char:FindFirstChild("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not hum or not root then return end

	Attacking = true
	_G.GCD = true

	local weapon = WeaponInfoFolder:FindFirstChild("Fist")
	if char:FindFirstChild("WeaponEquiped") then
		local w = WeaponInfoFolder:FindFirstChild(char.WeaponEquiped.Value)
		if w then weapon = w end
	end

	local animFolder = weapon and weapon:FindFirstChild("FanAnimations")
	local anim = animFolder and animFolder:FindFirstChild("P_".._G.Clicked)
	if anim and hum then
		hum:LoadAnimation(anim):Play()
	end

	if weapon then
		CombatEvent:FireServer(_G.Clicked, weapon, root.CFrame, true, weapon)
	end

	_G.Clicked += 1
	if _G.Clicked > 4 then
		_G.Clicked = 1
	end

	task.delay(0.4,function()
		Attacking = false
		_G.GCD = false
	end)
end

ResetComboEvent.OnClientEvent:Connect(function()
	_G.Clicked = 1
end)

-- ===== NPC HELPERS =====
local function updateNPCCache()
	state.npcCache = {}
	local char = player.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end
	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= char then
			local hum = npc:FindFirstChild("Humanoid")
			local r = npc:FindFirstChild("HumanoidRootPart")
			if hum and r and hum.Health > 0 then
				local dist = (root.Position - r.Position).Magnitude
				table.insert(state.npcCache, {model=npc, root=r, distance=dist})
			end
		end
	end
	table.sort(state.npcCache, function(a,b) return a.distance < b.distance end)
end

local function getClosestNPC()
	updateNPCCache()
	return state.npcCache[1]
end

-- ===== LOOPS =====
state.connections.autofarm = RunService.Heartbeat:Connect(function()
	if state.autofarmEnabled then
		local char = player.Character
		local root = char and char:FindFirstChild("HumanoidRootPart")
		if not root then return end

		local target = getClosestNPC()
		if target then
			state.lockedNPC = target.model
			root.CFrame = CFrame.new(target.root.Position - target.root.CFrame.LookVector*3.5 + Vector3.new(0,2.5,0))
		end
	end
end)

state.connections.killAura = RunService.Heartbeat:Connect(function()
	if state.killAuraEnabled then
		local char = player.Character
		local root = char and char:FindFirstChild("HumanoidRootPart")
		if not root then return end

		local npc = state.lockedNPC
		if npc then
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if npcRoot and (root.Position - npcRoot.Position).Magnitude <= 12 then
				DoAttack()
			end
		end
	end
end)

state.connections.speed = RunService.Heartbeat:Connect(function()
	if state.speedEnabled then
		local char = player.Character
		local hum = char and char:FindFirstChild("Humanoid")
		local root = char and char:FindFirstChild("HumanoidRootPart")
		if hum and root and hum.MoveDirection.Magnitude > 0 then
			root.AssemblyLinearVelocity = hum.MoveDirection.Unit * state.speedValue + Vector3.new(0, root.AssemblyLinearVelocity.Y,0)
		end
	end
end)

-- ===== INFINITE JUMP =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- ===== BUTTONS =====
autofarmBtn.MouseButton1Click:Connect(function()
	state.autofarmEnabled = not state.autofarmEnabled
	autofarmBtn.Text = state.autofarmEnabled and "ğŸ¤– Autofarm: ON" or "ğŸ¤– Autofarm: OFF"
end)

auraBtn.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	auraBtn.Text = state.killAuraEnabled and "ğŸ—¡ï¸ Kill Aura: ON" or "ğŸ—¡ï¸ Kill Aura: OFF"
end)

jumpBtn.MouseButton1Click:Connect(function()
	state.infiniteJumpEnabled = not state.infiniteJumpEnabled
	jumpBtn.Text = state.infiniteJumpEnabled and "ğŸš€ Infinite Jump: ON" or "ğŸš€ Infinite Jump: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	state.speedEnabled = not state.speedEnabled
	state.speedValue = tonumber(speedBox.Text) or state.speedValue
	speedBtn.Text = state.speedEnabled and "ğŸ’¨ Speed: ON" or "ğŸ’¨ Speed: OFF"
end)

-- ===== F1 (toggle GUI) =====
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == state.guiToggleKey then
		state.guiVisible = not state.guiVisible
		frame.Visible = state.guiVisible
	end
end)
