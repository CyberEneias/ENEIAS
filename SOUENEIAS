- ===== FFRE GUI V2 - STYLED EDITION =====
-- Design inspirado em NS HUB

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
if not player then return end

-- ===== CONFIG =====
local CONFIG = {
	BACK_DISTANCE = 3.5,
	HEIGHT_OFFSET = 2.5,
	MAX_DISTANCE = 60,
	NPC_SCAN_INTERVAL = 0.3,
	M1_CLICK_DELAY = 0.15,
	CHAR_CACHE_UPDATE = 0.5,
	GUI_NAME = "FFREStyledGui"
}

-- ===== NPC FOLDER =====
local AliveFolder = workspace:WaitForChild("Alive")

-- ===== CACHE =====
local Vector3_new = Vector3.new
local Vector3_zero = Vector3.zero
local CFrame_new = CFrame.new
local UDim2_new = UDim2.new
local Color3_fromRGB = Color3.fromRGB
local Color3_white = Color3.new(1,1,1)

-- ===== STATE =====
local state = {
	autofarmEnabled = false,
	infiniteJumpEnabled = false,
	speedEnabled = false,
	m1MacroEnabled = false,
	speedValue = 160,
	m1ClickDelay = CONFIG.M1_CLICK_DELAY,
	lockedNPC = nil,
	lastNPCScan = 0,
	npcCache = {},
	lastM1Click = 0,
	connections = {},
	guiVisible = true,
	guiToggleKey = Enum.KeyCode.F1,
	charCache = {
		root = nil,
		humanoid = nil,
		character = nil,
		lastUpdate = 0
	},
	lastSpeedApply = 0,
}

-- ===== UTILS =====
local function disconnectConnection(name)
	if state.connections[name] then
		state.connections[name]:Disconnect()
		state.connections[name] = nil
	end
end

local function cleanAllConnections()
	for name, conn in pairs(state.connections) do
		if conn and conn.Connected then
			conn:Disconnect()
		end
	end
	table.clear(state.connections)
end

local function getCharComponents()
	local now = tick()
	if now - state.charCache.lastUpdate > CONFIG.CHAR_CACHE_UPDATE then
		local char = player.Character
		state.charCache.character = char
		state.charCache.root = char and char:FindFirstChild("HumanoidRootPart")
		state.charCache.humanoid = char and char:FindFirstChildOfClass("Humanoid")
		state.charCache.lastUpdate = now
	end
	return state.charCache.root, state.charCache.humanoid, state.charCache.character
end

local function invalidateCharCache()
	state.charCache.lastUpdate = 0
end

-- ===== CLEAN OLD GUI =====
local oldGui = CoreGui:FindFirstChild(CONFIG.GUI_NAME)
if oldGui then oldGui:Destroy() end

-- ===== GUI CREATION (NS HUB STYLE) =====
local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = CONFIG.GUI_NAME
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Main Frame
local mainFrame = Instance.new("Frame", gui)
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2_new(0, 650, 0, 420)
mainFrame.Position = UDim2_new(0.5, -325, 0.5, -210)
mainFrame.BackgroundColor3 = Color3_fromRGB(15, 15, 20)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true

local mainCorner = Instance.new("UICorner", mainFrame)
mainCorner.CornerRadius = UDim.new(0, 10)

-- Shadow
local shadow = Instance.new("ImageLabel", mainFrame)
shadow.Name = "Shadow"
shadow.BackgroundTransparency = 1
shadow.Position = UDim2_new(0, -15, 0, -15)
shadow.Size = UDim2_new(1, 30, 1, 30)
shadow.ZIndex = 0
shadow.Image = "rbxassetid://5554236805"
shadow.ImageColor3 = Color3_fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.5
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(23, 23, 277, 277)

-- Sidebar
local sidebar = Instance.new("Frame", mainFrame)
sidebar.Name = "Sidebar"
sidebar.Size = UDim2_new(0, 160, 1, 0)
sidebar.Position = UDim2_new(0, 0, 0, 0)
sidebar.BackgroundColor3 = Color3_fromRGB(10, 10, 15)
sidebar.BorderSizePixel = 0

local sidebarCorner = Instance.new("UICorner", sidebar)
sidebarCorner.CornerRadius = UDim.new(0, 10)

-- Logo/Title em Sidebar
local logoLabel = Instance.new("TextLabel", sidebar)
logoLabel.Size = UDim2_new(1, -20, 0, 50)
logoLabel.Position = UDim2_new(0, 10, 0, 15)
logoLabel.BackgroundTransparency = 1
logoLabel.Text = "FFRE"
logoLabel.Font = Enum.Font.GothamBold
logoLabel.TextSize = 24
logoLabel.TextColor3 = Color3_fromRGB(200, 150, 255)
logoLabel.TextXAlignment = Enum.TextXAlignment.Left

local versionLabel = Instance.new("TextLabel", sidebar)
versionLabel.Size = UDim2_new(1, -20, 0, 20)
versionLabel.Position = UDim2_new(0, 10, 0, 45)
versionLabel.BackgroundTransparency = 1
versionLabel.Text = "v2.0 Ultimate"
versionLabel.Font = Enum.Font.Gotham
versionLabel.TextSize = 11
versionLabel.TextColor3 = Color3_fromRGB(150, 150, 160)
versionLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Separator
local separator = Instance.new("Frame", sidebar)
separator.Size = UDim2_new(1, -20, 0, 1)
separator.Position = UDim2_new(0, 10, 0, 75)
separator.BackgroundColor3 = Color3_fromRGB(40, 40, 50)
separator.BorderSizePixel = 0

-- Sidebar buttons list
local sidebarList = Instance.new("Frame", sidebar)
sidebarList.Size = UDim2_new(1, 0, 1, -85)
sidebarList.Position = UDim2_new(0, 0, 0, 85)
sidebarList.BackgroundTransparency = 1

local sidebarLayout = Instance.new("UIListLayout", sidebarList)
sidebarLayout.Padding = UDim.new(0, 2)
sidebarLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Content Area
local contentArea = Instance.new("Frame", mainFrame)
contentArea.Name = "ContentArea"
contentArea.Size = UDim2_new(1, -170, 1, -20)
contentArea.Position = UDim2_new(0, 165, 0, 10)
contentArea.BackgroundTransparency = 1

-- Content Title
local contentTitle = Instance.new("TextLabel", contentArea)
contentTitle.Name = "Title"
contentTitle.Size = UDim2_new(1, 0, 0, 35)
contentTitle.Position = UDim2_new(0, 0, 0, 0)
contentTitle.BackgroundTransparency = 1
contentTitle.Text = "|| COMBAT"
contentTitle.Font = Enum.Font.GothamBold
contentTitle.TextSize = 16
contentTitle.TextColor3 = Color3_white
contentTitle.TextXAlignment = Enum.TextXAlignment.Left

-- Subtitle
local subtitle = Instance.new("TextLabel", contentArea)
subtitle.Size = UDim2_new(1, 0, 0, 20)
subtitle.Position = UDim2_new(0, 0, 0, 30)
subtitle.BackgroundTransparency = 1
subtitle.Text = "⚡ Advanced Combat Features"
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 12
subtitle.TextColor3 = Color3_fromRGB(150, 150, 160)
subtitle.TextXAlignment = Enum.TextXAlignment.Left

-- Scrolling Frame for options
local scrollFrame = Instance.new("ScrollingFrame", contentArea)
scrollFrame.Size = UDim2_new(1, -10, 1, -60)
scrollFrame.Position = UDim2_new(0, 0, 0, 55)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 4
scrollFrame.ScrollBarImageColor3 = Color3_fromRGB(100, 80, 150)
scrollFrame.CanvasSize = UDim2_new(0, 0, 0, 0)
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

local scrollLayout = Instance.new("UIListLayout", scrollFrame)
scrollLayout.Padding = UDim.new(0, 8)
scrollLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Function to create iOS-style toggle
local function createToggle(parent, text, description, callback)
	local container = Instance.new("Frame", parent)
	container.Size = UDim2_new(1, -5, 0, 65)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	
	local corner = Instance.new("UICorner", container)
	corner.CornerRadius = UDim.new(0, 8)
	
	local label = Instance.new("TextLabel", container)
	label.Size = UDim2_new(1, -80, 0, 20)
	label.Position = UDim2_new(0, 12, 0, 10)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	
	local desc = Instance.new("TextLabel", container)
	desc.Size = UDim2_new(1, -80, 0, 30)
	desc.Position = UDim2_new(0, 12, 0, 30)
	desc.BackgroundTransparency = 1
	desc.Text = description
	desc.Font = Enum.Font.Gotham
	desc.TextSize = 11
	desc.TextColor3 = Color3_fromRGB(150, 150, 160)
	desc.TextXAlignment = Enum.TextXAlignment.Left
	desc.TextWrapped = true
	desc.TextYAlignment = Enum.TextYAlignment.Top
	
	-- Toggle button (iOS style)
	local toggleBtn = Instance.new("TextButton", container)
	toggleBtn.Size = UDim2_new(0, 45, 0, 24)
	toggleBtn.Position = UDim2_new(1, -57, 0, 20)
	toggleBtn.BackgroundColor3 = Color3_fromRGB(50, 50, 60)
	toggleBtn.BorderSizePixel = 0
	toggleBtn.Text = ""
	toggleBtn.AutoButtonColor = false
	
	local toggleCorner = Instance.new("UICorner", toggleBtn)
	toggleCorner.CornerRadius = UDim.new(1, 0)
	
	local toggleCircle = Instance.new("Frame", toggleBtn)
	toggleCircle.Size = UDim2_new(0, 18, 0, 18)
	toggleCircle.Position = UDim2_new(0, 3, 0.5, -9)
	toggleCircle.BackgroundColor3 = Color3_white
	toggleCircle.BorderSizePixel = 0
	
	local circleCorner = Instance.new("UICorner", toggleCircle)
	circleCorner.CornerRadius = UDim.new(1, 0)
	
	local isOn = false
	
	toggleBtn.MouseButton1Click:Connect(function()
		isOn = not isOn
		
		local targetColor = isOn and Color3_fromRGB(120, 80, 200) or Color3_fromRGB(50, 50, 60)
		local targetPos = isOn and UDim2_new(1, -21, 0.5, -9) or UDim2_new(0, 3, 0.5, -9)
		
		TweenService:Create(toggleBtn, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
		TweenService:Create(toggleCircle, TweenInfo.new(0.2), {Position = targetPos}):Play()
		
		callback(isOn)
	end)
	
	return container, toggleBtn, isOn
end

-- Function to create slider
local function createSlider(parent, text, minVal, maxVal, defaultVal, callback)
	local container = Instance.new("Frame", parent)
	container.Size = UDim2_new(1, -5, 0, 70)
	container.BackgroundColor3 = Color3_fromRGB(20, 20, 28)
	container.BorderSizePixel = 0
	
	local corner = Instance.new("UICorner", container)
	corner.CornerRadius = UDim.new(0, 8)
	
	local label = Instance.new("TextLabel", container)
	label.Size = UDim2_new(0.7, 0, 0, 20)
	label.Position = UDim2_new(0, 12, 0, 10)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3_white
	label.TextXAlignment = Enum.TextXAlignment.Left
	
	local valueLabel = Instance.new("TextLabel", container)
	valueLabel.Size = UDim2_new(0.3, -12, 0, 20)
	valueLabel.Position = UDim2_new(0.7, 0, 0, 10)
	valueLabel.BackgroundTransparency = 1
	valueLabel.Text = tostring(defaultVal)
	valueLabel.Font = Enum.Font.GothamBold
	valueLabel.TextSize = 14
	valueLabel.TextColor3 = Color3_fromRGB(200, 150, 255)
	valueLabel.TextXAlignment = Enum.TextXAlignment.Right
	
	-- Slider bar
	local sliderBar = Instance.new("Frame", container)
	sliderBar.Size = UDim2_new(1, -24, 0, 6)
	sliderBar.Position = UDim2_new(0, 12, 0, 45)
	sliderBar.BackgroundColor3 = Color3_fromRGB(40, 40, 50)
	sliderBar.BorderSizePixel = 0
	
	local sliderCorner = Instance.new("UICorner", sliderBar)
	sliderCorner.CornerRadius = UDim.new(1, 0)
	
	local sliderFill = Instance.new("Frame", sliderBar)
	sliderFill.Size = UDim2_new((defaultVal - minVal) / (maxVal - minVal), 0, 1, 0)
	sliderFill.BackgroundColor3 = Color3_fromRGB(120, 80, 200)
	sliderFill.BorderSizePixel = 0
	
	local fillCorner = Instance.new("UICorner", sliderFill)
	fillCorner.CornerRadius = UDim.new(1, 0)
	
	local sliderButton = Instance.new("TextButton", sliderBar)
	sliderButton.Size = UDim2_new(1, 0, 1, 10)
	sliderButton.Position = UDim2_new(0, 0, 0, -5)
	sliderButton.BackgroundTransparency = 1
	sliderButton.Text = ""
	sliderButton.AutoButtonColor = false
	
	local dragging = false
	
	sliderButton.MouseButton1Down:Connect(function()
		dragging = true
	end)
	
	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	
	sliderButton.MouseMoved:Connect(function(x)
		if dragging then
			local relativeX = math.clamp((x - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
			local value = math.floor(minVal + (maxVal - minVal) * relativeX)
			
			sliderFill.Size = UDim2_new(relativeX, 0, 1, 0)
			valueLabel.Text = tostring(value)
			callback(value)
		end
	end)
	
	sliderButton.MouseButton1Click:Connect(function(x)
		local relativeX = math.clamp((x - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
		local value = math.floor(minVal + (maxVal - minVal) * relativeX)
		
		sliderFill.Size = UDim2_new(relativeX, 0, 1, 0)
		valueLabel.Text = tostring(value)
		callback(value)
	end)
	
	return container, valueLabel
end

-- ===== CREATE UI ELEMENTS =====

-- Autofarm Toggle
createToggle(scrollFrame, "Enable Autofarm", "Teleports you behind nearest NPC automatically", function(enabled)
	state.autofarmEnabled = enabled
	if enabled then
		disconnectConnection("autofarm")
		state.connections.autofarm = RunService.Heartbeat:Connect(autofarmLoop)
	else
		disconnectConnection("autofarm")
	end
end)

-- Speed Toggle
createToggle(scrollFrame, "Enable Speed", "Increases your movement speed significantly", function(enabled)
	state.speedEnabled = enabled
	if enabled then
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	else
		disconnectConnection("speed")
	end
end)

-- Speed Slider
createSlider(scrollFrame, "Speed Value", 50, 300, 160, function(value)
	state.speedValue = value
end)

-- Infinite Jump Toggle
createToggle(scrollFrame, "Enable Infinite Jump", "Jump infinitely while in mid-air", function(enabled)
	state.infiniteJumpEnabled = enabled
end)

-- M1 Macro Toggle
createToggle(scrollFrame, "Enable M1 Macro", "Automatically clicks M1 (Toggle: F2)", function(enabled)
	state.m1MacroEnabled = enabled
	if enabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	else
		disconnectConnection("m1macro")
	end
end)

-- M1 Delay Slider
createSlider(scrollFrame, "M1 Click Delay", 5, 50, 15, function(value)
	state.m1ClickDelay = value / 100
end)

-- Info Section
local infoContainer = Instance.new("Frame", scrollFrame)
infoContainer.Size = UDim2_new(1, -5, 0, 85)
infoContainer.BackgroundColor3 = Color3_fromRGB(25, 20, 35)
infoContainer.BorderSizePixel = 0

local infoCorner = Instance.new("UICorner", infoContainer)
infoCorner.CornerRadius = UDim.new(0, 8)

local infoTitle = Instance.new("TextLabel", infoContainer)
infoTitle.Size = UDim2_new(1, -20, 0, 20)
infoTitle.Position = UDim2_new(0, 10, 0, 8)
infoTitle.BackgroundTransparency = 1
infoTitle.Text = "ℹ️ Keybinds"
infoTitle.Font = Enum.Font.GothamBold
infoTitle.TextSize = 13
infoTitle.TextColor3 = Color3_fromRGB(200, 150, 255)
infoTitle.TextXAlignment = Enum.TextXAlignment.Left

local infoText = Instance.new("TextLabel", infoContainer)
infoText.Size = UDim2_new(1, -20, 0, 55)
infoText.Position = UDim2_new(0, 10, 0, 28)
infoText.BackgroundTransparency = 1
infoText.Text = "F1 - Toggle GUI\nF2 - Toggle M1 Macro\n\nCombine Autofarm + M1 Macro for full auto farm!"
infoText.Font = Enum.Font.Gotham
infoText.TextSize = 11
infoText.TextColor3 = Color3_fromRGB(180, 180, 190)
infoText.TextXAlignment = Enum.TextXAlignment.Left
infoText.TextYAlignment = Enum.TextYAlignment.Top
infoText.TextWrapped = true

-- ===== NPC CACHE =====
local function updateNPCCache()
	table.clear(state.npcCache)
	local root, _, _ = getCharComponents()
	if not root then return end

	for _, npc in ipairs(AliveFolder:GetChildren()) do
		if npc:IsA("Model") and npc ~= player.Character then
			local hum = npc:FindFirstChild("Humanoid")
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			if hum and npcRoot and hum.Health > 0 then
				local dist = (root.Position - npcRoot.Position).Magnitude
				if dist <= CONFIG.MAX_DISTANCE then
					table.insert(state.npcCache, {model=npc, root=npcRoot, humanoid=hum, distance=dist})
				end
			end
		end
	end

	table.sort(state.npcCache, function(a,b) return a.distance < b.distance end)
end

local function findClosestNPC()
	local now = tick()
	if now - state.lastNPCScan > CONFIG.NPC_SCAN_INTERVAL then
		updateNPCCache()
		state.lastNPCScan = now
	end
	return state.npcCache[1] and state.npcCache[1].model
end

-- ===== M1 MACRO =====
function m1MacroLoop()
	if not state.m1MacroEnabled then return end
	
	local now = tick()
	if now - state.lastM1Click < state.m1ClickDelay then return end
	
	pcall(function()
		mouse1click()
	end)
	
	state.lastM1Click = now
end

-- ===== AUTOFARM =====
function autofarmLoop()
	if not state.autofarmEnabled then return end

	local root, _, _ = getCharComponents()
	if not root then return end

	if not state.lockedNPC or not state.lockedNPC.Parent then
		state.lockedNPC = findClosestNPC()
	end

	local npc = state.lockedNPC
	if not npc then return end

	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	root.AssemblyLinearVelocity = Vector3_zero
	root.AssemblyAngularVelocity = Vector3_zero

	root.CFrame = CFrame_new(
		npcRoot.Position
		- npcRoot.CFrame.LookVector * CONFIG.BACK_DISTANCE
		+ Vector3_new(0, CONFIG.HEIGHT_OFFSET, 0)
	)
end

-- ===== SPEED =====
function speedLoop()
	if not state.speedEnabled then return end
	
	local now = tick()
	if now - state.lastSpeedApply < 0.016 then return end
	
	local root, hum, _ = getCharComponents()
	if root and hum and hum.MoveDirection.Magnitude > 0 then
		root.AssemblyLinearVelocity =
			hum.MoveDirection.Unit * state.speedValue +
			Vector3_new(0, root.AssemblyLinearVelocity.Y, 0)
		state.lastSpeedApply = now
	end
end

-- ===== INPUT HANDLING =====
UserInputService.JumpRequest:Connect(function()
	if state.infiniteJumpEnabled then
		local _, hum, _ = getCharComponents()
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end

	-- F1 - Toggle GUI
	if input.KeyCode == Enum.KeyCode.F1 then
		state.guiVisible = not state.guiVisible
		mainFrame.Visible = state.guiVisible
	end

	-- F2 - Toggle M1 Macro
	if input.KeyCode == Enum.KeyCode.F2 then
		state.m1MacroEnabled = not state.m1MacroEnabled
		
		if state.m1MacroEnabled then
			disconnectConnection("m1macro")
			state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
		else
			disconnectConnection("m1macro")
		end
	end
end)

-- ===== CHARACTER EVENTS =====
player.CharacterAdded:Connect(function(char)
	invalidateCharCache()
	task.wait(0.3)
	
	if state.speedEnabled then
		disconnectConnection("speed")
		state.connections.speed = RunService.Heartbeat:Connect(speedLoop)
	end
	if state.m1MacroEnabled then
		disconnectConnection("m1macro")
		state.connections.m1macro = RunService.Heartbeat:Connect(m1MacroLoop)
	end
end)

-- ===== CLEANUP =====
game:GetService("Players").LocalPlayer.OnTeleport:Connect(function()
	cleanAllConnections()
end)

print("═══════════════════════════════════")
print("  FFRE GUI V2 - STYLED EDITION")
print("═══════════════════════════════════")
print("  [✓] Autofarm")
print("  [✓] Speed Boost")
print("  [✓] Infinite Jump")
print("  [✓] M1 Macro")
print("═══════════════════════════════════")
print("  Keybinds:")
print("  F1 - Toggle GUI")
print("  F2 - Toggle M1 Macro")
print("═══════════════════════════════════")
